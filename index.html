<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jasper Industries API</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <script type="module">
        // Ensure global app, db, auth, and other Firebase services are defined
        window.app = null;
        window.db = null;
        window.auth = null;
        window.fs = {}; // Firestore functions
        window.currentUserId = null;
        window.currentUserName = null; // New: Store the logged-in user's name/role
        window.inquiryUnsubscribe = null; // To stop Firestore listener on logout
        window.sourcingUnsubscribe = null; // To stop Sourcing listener on logout


        // ====================================================================
        // START: MANUAL CONFIGURATION FOR OTHER DEVICES
        // ====================================================================
        //
        // To run this app on another device, you MUST manually copy/paste
        // your keys here.
        // 1. Open the F12 Console in *this* browser.
        // 2. Find the 'appId' (it looks like 'default-app-id' or a long random string).
        // 3. Find the 'Firebase Config:' object and copy the whole { ... } object.
        // 4. Paste them below, replacing 'PASTE_YOUR_APP_ID_HERE' and '{}'.
        //
        const MANUAL_APP_ID = 'PASTE_YOUR_APP_ID_HERE'; // e.g., 'default-app-id'
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAkFTJyLXNMfrWxV4qIt1J0FOxTa-lRU0E",
            authDomain: "jasper-industries-portal-6925b.firebaseapp.com",
            projectId: "jasper-industries-portal-6925b",
            storageBucket: "jasper-industries-portal-6925b.firebasestorage.app",
            messagingSenderId: "133802184411",
            appId: "1:133802184411:web:99efc56396d1c4ec0986fe",
            measurementId: "G-VJB2D9590N"
        };
        // ====================================================================
        // END: MANUAL CONFIGURATION
        // ====================================================================


        // Use manual keys if available, otherwise use the injected session keys
        window.appId = (MANUAL_APP_ID !== 'PASTE_YOUR_APP_ID_HERE' && MANUAL_APP_ID) ?
            MANUAL_APP_ID :
            (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');

        const firebaseConfigString = (MANUAL_FIREBASE_CONFIG && Object.keys(MANUAL_FIREBASE_CONFIG).length > 0) ?
            JSON.stringify(MANUAL_FIREBASE_CONFIG) :
            (typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');


        // === Firebase Initialization ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigString);

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing or incomplete.");
                    // Display error to user in a non-alert way
                    const loginError = document.getElementById('loginError');
                    if (loginError) {
                        loginError.textContent = "Error: Application configuration is missing. Please contact support.";
                        loginError.classList.remove('hidden');
                    }
                    return false; // Indicate failure
                }

                console.log("Firebase Config:", firebaseConfig);

                // Import specific functions from the Firebase SDK
                const {
                    initializeApp
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const {
                    getAuth,
                    signInAnonymously,
                    signInWithCustomToken,
                    onAuthStateChanged,
                    signOut
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const {
                    getFirestore,
                    doc,
                    setDoc,
                    addDoc,
                    onSnapshot,
                    collection,
                    query,
                    serverTimestamp,
                    setLogLevel,
                    runTransaction, // Needed for sequential counter
                    getDoc, // Needed for transaction
                    updateDoc, // Needed for status/notes
                    arrayUnion, // Needed for adding notes
                    getDocs, // Needed for Sourcing form query
                    where, // Needed for Sourcing form query
                    deleteDoc // NEW: For permanent delete
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                // === Initialize Firebase ---
                try {
                    window.app = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.app);
                    window.auth = getAuth(window.app);
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    // Gracefully handle initialization failure
                    window.app = null;
                    window.db = null;
                    window.auth = null;
                    console.log('Firebase Auth initialization failed. Using local authentication only.');
                }

                // Assign firestore functions to window.fs for easy access
                window.fs = {
                    doc,
                    setDoc,
                    addDoc,
                    onSnapshot,
                    collection,
                    query,
                    serverTimestamp,
                    runTransaction,
                    getDoc,
                    updateDoc,
                    arrayUnion,
                    getDocs,
                    where,
                    deleteDoc // NEW: Added deleteDoc
                };

                // Enable debug logging for Firestore
                setLogLevel('Debug');

                // === Authentication ---
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        console.log("Firebase Auth: User is signed in.", user.uid);
                        window.currentUserId = user.uid; // Still useful for knowing *who* is logged in, even if data is public
                    } else {
                        console.log("Firebase Auth: User is signed out. Attempting to sign in...");
                        window.currentUserId = null;
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("Attempting sign in with custom token...");
                                await signInWithCustomToken(window.auth, __initial_auth_token);
                            } else {
                                console.log("Attempting anonymous sign in...");
                                await signInAnonymously(window.auth);
                            }
                        } catch (error) {
                            console.error("Firebase Authentication Error:", error);
                            const loginError = document.getElementById('loginError');
                            if (loginError) {
                                loginError.textContent = `Authentication Failed: ${error.message}`;
                                loginError.classList.remove('hidden');
                            }
                        }
                    }
                });

                // Make signOut globally available for the logout button
                window.handleUserLogout = async () => {
                    try {
                        // Unsubscribe from Firestore listeners to prevent errors
                        if (window.inquiryUnsubscribe) {
                            console.log("Unsubscribing from inquiry listener...");
                            window.inquiryUnsubscribe();
                            window.inquiryUnsubscribe = null;
                        }
                        if (window.sourcingUnsubscribe) {
                            console.log("Unsubscribing from sourcing listener...");
                            window.sourcingUnsubscribe();
                            window.sourcingUnsubscribe = null;
                        }
                        // Clear the current user role/name
                        window.currentUserName = null;
                        // We don't sign out of Firebase Auth itself, as it's needed for the app
                        // We just "log out" of the privileged session.
                        console.log("Handling app-level logout.");
                        renderLoginPage();
                    } catch (error) {
                        console.error("Error during logout:", error);
                    }
                };
                return true; // Indicate success

            } catch (error) {
                console.error("Error loading Firebase SDK:", error);
                const loginError = document.getElementById('loginError');
                if (loginError) {
                    loginError.textContent = "Error loading application components. Please refresh.";
                    loginError.classList.remove('hidden');
                }
                return false; // Indicate failure
            }
        }

        // Call initialization
        initializeFirebase();
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Basic styles for tabs */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-button.active {
            border-bottom-color: #1e40af;
            /* blue-800 */
            color: #1e40af;
            /* blue-800 */
            font-weight: 600;
        }

        /* Modal styles */
        #inquiryModal,
        #sourcingModal {
            transition: opacity 0.3s ease;
        }

        /* Styling for the ref link */
        .ref-link {
            color: #1e40af;
            /* blue-800 */
            font-weight: 500;
            text-decoration: underline;
            cursor: pointer;
        }

        .ref-link:hover {
            color: #1d4ed8;
            /* blue-700 */
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-blue-100">
    <div id="app-container" class="min-h-screen">
    </div>

    <script>
        // === CONSTANTS ---
        const JASPER_LOGO_URL = "https://jasperegypt.com/home/wp-content/uploads/2023/12/logooo1-1.png"; // Updated logo URL
        const INQUIRY_COLLECTION_PATH = (appId) => `/artifacts/${appId}/public/data/inquiries`;
        const COUNTER_DOC_PATH = (appId) => `/artifacts/${appId}/public/data/inquiries_counter/counter`;

        // === STATE ---
        let currentView = 'login'; // 'login', 'inq', 'source'
        let allInquiries = []; // Holds the full list of inquiries for searching

        // === UTILITY FUNCTIONS ---

        /**
         * Formats a Firestore timestamp (or Date object) into a readable string.
         * Returns 'N/A' if the timestamp is invalid.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) {
                return 'N/A';
            }
            try {
                let date;
                if (timestamp && typeof timestamp.toDate === 'function') {
                    // It's a Firestore Timestamp
                    date = timestamp.toDate();
                } else if (timestamp instanceof Date) {
                    // It's a standard Date object
                    date = timestamp;
                } else {
                    // Try parsing it if it's a string or number
                    date = new Date(timestamp);
                }

                if (isNaN(date.getTime())) {
                    // Invalid date
                    return 'N/A';
                }

                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (error) {
                console.error("Error formatting timestamp:", error, timestamp);
                return 'N/A';
            }
        }


        /**
         * Safely gets a value from a data object, returning 'N/A' if empty or undefined.
         */
        function getData(value) {
            return value || 'N/A';
        }

        // === PAGE RENDERING FUNCTIONS ---

        /**
         * Clears the app container and renders the Login Page.
         */
        function renderLoginPage() {
            currentView = 'login';
            window.currentUserName = null; // Clear user name on logout
            allInquiries = []; // Clear inquiry cache on logout
            const container = document.getElementById('app-container');
            if (!container) return;

            container.innerHTML = `
					<div class="flex min-h-screen items-center justify-center bg-transparent p-4">
						<div class="w-full max-w-md">
							<div class="bg-white shadow-xl rounded-2xl p-8 md:p-12">
								<div class="flex justify-center mb-8">
									<img src="${JASPER_LOGO_URL}" alt="Jasper Industries Logo" class="h-16" onerror="this.alt='Jasper Industries'; this.src='https://placehold.co/200x60/1e40af/FFFFFF?text=Jasper';">
								</div>
								
								<h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Internal Portal</h2>

								<form id="loginForm">
									<div class="mb-5">
										<label for="loginUser" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
										<input type="text" id="loginUser" name="loginUser"
											class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent"
											required>
									</div>
									<div class="mb-6">
										<label for="loginPass" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
										<input type="password" id="loginPass" name="loginPass"
											class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent"
											required>
									</div>
									<div class="mb-6">
										<button type="submit"
											class="w-full bg-blue-800 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-800 focus:ring-opacity-50 transition duration-200 shadow-md">
											Login
										</button>
									</div>
									<div id="loginError" class="hidden text-center text-red-600 text-sm font-medium p-3 bg-red-100 rounded-lg">
										</div>
								</form>
							</div>
							<p class="text-center text-gray-500 text-xs mt-6">
								Copyright © 2023 Jasper Egypt . All Rights Reserved
							</p>
						</div>
					</div>
				`;

            // Add event listener to the new form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        /**
         * Clears the app container and renders the Inquiry Dashboard.
         */
        function renderInquiryPage() {
            currentView = 'inq';
            const container = document.getElementById('app-container');
            if (!container) return;
            const isAdmin = window.currentUserName === 'admin';
            const adminTabHtml = isAdmin ? `
					<button id="tab-admin" class="tab-button text-red-500 hover:text-red-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
						Admin Console
					</button>` : '';

            // The Inquiry page has a white header, so we set the main background to gray
            // The body gradient will be covered, which is fine for this view.
            container.innerHTML = `
					<div class="min-h-screen bg-gray-100">
						<header class="bg-white shadow-md sticky top-0 z-10">
							<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
								<div class="flex justify-between items-center h-16">
									<div class="flex items-center">
										<img src="${JASPER_LOGO_URL}" alt="Jasper Logo" class="h-10" onerror="this.alt='Jasper'; this.src='https://placehold.co/150x40/1e40af/FFFFFF?text=Jasper';">
										<span class="ml-3 text-xl font-semibold text-gray-700">Inquiry Portal</span>
                                        <span class="ml-4 text-sm font-light text-gray-500">(${window.currentUserName.toUpperCase()})</span>
									</div>
									<button id="logoutButton" class="text-sm font-medium text-red-600 hover:text-red-800 transition duration-150">
										Logout
									</button>
								</div>
							</div>
						</header>

						<main class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
							<div class="border-b border-gray-200 mb-6">
								<nav class="-mb-px flex space-x-8" aria-label="Tabs">
									<button id="tab-dashboard" class="tab-button active text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
										Dashboard
									</button>
									<button id="tab-form" class="tab-button text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
										New Inquiry Form
									</button>
									<button id="tab-analytics" class="tab-button text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
										Analytics
									</button>
                                    ${adminTabHtml}
								</nav>
							</div>

							<div>
								<div id="content-dashboard" class="tab-content active">
									<div class="mb-4">
										<input type="text" id="search-bar" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800" placeholder="Search by Ref #, Client, Material, Status, or Date...">
									</div>
									<h2 class="text-2xl font-semibold text-gray-800 mb-4">Client Inquiries</h2>
									<div class="bg-white shadow-lg rounded-lg overflow-hidden">
										<div class="overflow-x-auto">
											<table class="min-w-full divide-y divide-gray-200">
												<thead class="bg-gray-50">
													<tr>
														<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref #</th>
														<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
														<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted By</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
														<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
														<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
														<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target Price</th>
													</tr>
												</thead>
												<tbody id="inquiry-table-body" class="bg-white divide-y divide-gray-200">
													<tr>
														<td colspan="7" class="px-6 py-10 text-center text-gray-500">
															Loading inquiries...
														</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>

								<div id="content-form" class="tab-content">
									<h2 class="text-2xl font-semibold text-gray-800 mb-4">Submit New Client Inquiry</h2>
									<div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
										<form id="new-inquiry-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
											<div class="md:col-span-1">
												<label for="clientName" class="block text-sm font-medium text-gray-700">Client Name</label>
												<input type="text" id="clientName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>
											<div class="md:col-span-1">
												<label for="organization" class="block text-sm font-medium text-gray-700">Organization</label>
												<input type="text" id="organization" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>
											<div class="md:col-span-1">
												<label for="mobileNumber" class="block text-sm font-medium text-gray-700">Mobile Number</label>
												<input type="tel" id="mobileNumber" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>
											<div class="md:col-span-1">
												<label for="email" class="block text-sm font-medium text-gray-700">Email</label>
												<input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>

											<hr class="md:col-span-2 my-2">
											
											<div class="md:col-span-1">
												<label for="material" class="block text-sm font-medium text-gray-700">Material</label>
												<input type="text" id="material" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>
											<div class="md:col-span-1">
												<label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
												<input type="text" id="quantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>
											<div class="md:col-span-2">
												<label for="specifications" class="block text-sm font-medium text-gray-700">Specifications</label>
												<textarea id="specifications" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent"></textarea>
											</div>

											<hr class="md:col-span-2 my-2">

											<div class="md:col-span-1">
												<label for="recommendedSupplier" class="block text-sm font-medium text-gray-700">Recommended Supplier</label>
												<input type="text" id="recommendedSupplier" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>
											<div class="md:col-span-1">
												<label for="targetPrice" class="block text-sm font-medium text-gray-700">Target Price / Unit</label>
												<input type="text" id="targetPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
											</div>

											<div class="md:col-span-2 flex justify-end items-center gap-4 mt-4">
												<span id="form-message" class="text-sm text-green-600"></span>
												<button type="submit" id="submit-form-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-800 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-800">
													Submit Inquiry
												</button>
											</div>
										</form>
									</div>
								</div>

								<div id="content-analytics" class="tab-content">
									<h2 class="text-2xl font-semibold text-gray-800 mb-4">Inquiry Analytics</h2>
									<div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
										<p class="text-gray-600">This section will provide insights into monthly orders, average completion time, and other metrics.</p>
										<p class="text-gray-500 text-sm mt-4">(Analytics feature is currently under development)</p>
									</div>
								</div>

                                <div id="content-admin" class="tab-content">
                                    <h2 class="text-2xl font-semibold text-red-600 mb-6">Admin Console (DANGER ZONE)</h2>
                                    
                                    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Database Operations</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="border p-4 rounded-lg bg-red-50">
                                                <p class="text-sm font-medium text-red-700 mb-2">WARNING: Soft-Deletes Only</p>
                                                <button id="reset-database-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-600 transition duration-200">
                                                    Reset Inquiry Progress (Back to Ref #1)
                                                </button>
                                                <p id="reset-message" class="text-xs text-red-500 mt-2">Resets the counter to 0 and soft-deletes all existing inquiries. You must manually delete them permanently from the bin.</p>
                                            </div>
                                            <div class="border p-4 rounded-lg bg-red-100">
                                                <p class="text-sm font-medium text-red-800 mb-2">DANGER: Permanent Deletion</p>
                                                <button id="hard-delete-deleted-btn" class="w-full bg-red-700 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-800 transition duration-200">
                                                    Permanently Delete All in Recycle Bin
                                                </button>
                                                <p id="hard-delete-message" class="text-xs text-red-600 mt-2">This action cannot be undone. All documents with 'isDeleted: true' will be purged.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recycle Bin (Soft Deleted Inquiries)</h3>
                                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref #</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Deleted</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recycle-bin-table-body" class="bg-white divide-y divide-gray-200">
                                                    <tr>
                                                        <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                                                            No soft-deleted inquiries.
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
							</div>
						</main>
					</div>

					<div id="inquiryModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
						<div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
							<div class="flex justify-between items-center border-b pb-3 mb-4">
								<h3 class="text-2xl font-semibold text-gray-900">Inquiry Details (Ref #: <span id="modal-ref-num"></span>)</h3>
								<button id="modal-close-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
									<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
								</button>
							</div>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
								<div>
									<h4 class="text-lg font-semibold text-gray-800 mb-2">Client & Inquiry</h4>
                                    <dl class="divide-y divide-gray-200">
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Submitted By</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-submittedBy"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Client Name</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-clientName"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Organization</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-organization"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Contact</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><span id="modal-mobileNumber"></span><br><span id="modal-email"></span></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Material</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-material"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Quantity</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-quantity"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Target Price</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-targetPrice"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Rec. Supplier</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-recommendedSupplier"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Specs</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 whitespace-pre-wrap" id="modal-specifications"></dd></div>
									</dl>
									<hr class="my-4">
									<h4 class="text-lg font-semibold text-gray-800 mb-2">Update Status</h4>
									<div class="flex items-center gap-4">
										<select id="modal-status-select" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
											<option value="New">New</option>
											<option value="In Progress">In Progress</option>
											<option value="Completed">Completed</option>
											<option value="Cancelled">Cancelled</option>
										</select>
										<button id="modal-status-save" class="px-4 py-2 bg-blue-800 text-white text-sm font-medium rounded-md hover:bg-blue-700">Save</button>
									</div>
									<span id="modal-status-message" class="text-sm text-green-600 mt-2 block"></span>

                                    <button id="modal-delete-btn" class="w-full mt-4 px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-md hover:bg-red-600">
                                        <span id="modal-delete-text">Delete Inquiry</span>
                                    </button>
                                    </div>
								<div class="bg-gray-50 p-4 rounded-lg flex flex-col h-full max-h-[70vh]">
									<h4 class="text-lg font-semibold text-gray-800 mb-2">Notes</h4>
									<div id="modal-notes-list" class="flex-grow overflow-y-auto space-y-3 mb-4 pr-2">
										<p class="text-gray-500 text-sm">No notes yet.</p>
									</div>
									<div class="flex-shrink-0">
										<textarea id="modal-new-note" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800" rows="3" placeholder="Add a new note..."></textarea>
										<button id="modal-note-add" class="w-full mt-2 px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-500">Add Note</button>
										<span id="modal-note-message" class="text-sm text-green-600 mt-2 block"></span>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div id="sourcingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
						<div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
							<div class="flex justify-between items-center border-b pb-3 mb-4">
								<h3 class="text-2xl font-semibold text-gray-900">Sourcing Details (Ref #: <span id="modal-sourcing-ref-num"></span>)</h3>
								<button id="modal-sourcing-close-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
									<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
								</button>
							</div>
							<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
								<div class="md:col-span-1">
									<h4 class="text-lg font-semibold text-gray-800 mb-2">Original Inquiry</h4>
									<dl class="divide-y divide-gray-200">
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Submitted By</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-submittedBy"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Client</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-clientName"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Org</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-organization"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Material</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-material"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Quantity</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-quantity"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Target Price</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-targetPrice"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Specs</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 whitespace-pre-wrap" id="modal-sourcing-specifications"></dd></div>
									</dl>
									<hr class="my-4">
									<h4 class="text-lg font-semibold text-gray-800 mb-2">Sourcing Data</h4>
									<dl class="divide-y divide-gray-200">
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Supplier</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-supplier"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Price</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-price"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Payment</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-paymentMethod"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">COA</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-coa"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">License</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-license"></dd></div>
										<div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Certificate</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-quality"></dd></div>
									</dl>
								</div>

								<div class="md:col-span-1">
									<h4 class="text-lg font-semibold text-gray-800 mb-2">Update Sourcing Status</h4>
									<div class="space-y-4">
										<div>
											<label for="modal-sourcingClientPO" class="block text-sm font-medium text-gray-700">Client PO</label>
											<select id="modal-sourcingClientPO" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
												<option value="No">No</option>
												<option value="Yes">Yes</option>
											</select>
										</div>
										<div>
											<label for="modal-sourcingClientPayment" class="block text-sm font-medium text-gray-700">Client Payment</label>
											<select id="modal-sourcingClientPayment" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
												<option value="Not Required">Not Required</option>
												<option value="Required">Required</option>
												<option value="Collected">Collected</option>
											</select>
										</div>
										<div>
											<label for="modal-sourcingImportPermit" class="block text-sm font-medium text-gray-700">Import Permit</label>
											<select id="modal-sourcingImportPermit" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
												<option value="Not Required">Not Required</option>
												<option value="Pending">Pending</option>
												<option value="Completed">Completed</option>
											</select>
										</div>
										<div>
											<label for="modal-sourcingSupplierPO" class="block text-sm font-medium text-gray-700">Supplier PO</label>
											<select id="modal-sourcingSupplierPO" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
												<option value="Not Yet">Not Yet</option>
												<option value="Sent">Sent</option>
											</select>
										</div>
									</div>
									<button id="modal-sourcing-status-save" class="w-full mt-6 px-4 py-2 bg-blue-800 text-white text-sm font-medium rounded-md hover:bg-blue-700">Save Statuses</button>
									<span id="modal-sourcing-status-message" class="text-sm text-green-600 mt-2 block"></span>

                                    <button id="modal-sourcing-delete-btn" class="w-full mt-4 px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-md hover:bg-red-600">
                                        <span id="modal-sourcing-delete-text">Delete Inquiry</span>
                                    </button>
                                    </div>

								<div class="bg-gray-50 p-4 rounded-lg flex flex-col h-full max-h-[70vh] md:col-span-1">
									<h4 class="text-lg font-semibold text-gray-800 mb-2">Notes</h4>
									<div id="modal-sourcing-notes-list" class="flex-grow overflow-y-auto space-y-3 mb-4 pr-2">
										<p class="text-gray-500 text-sm">No notes yet.</p>
									</div>
									<div class="flex-shrink-0">
										<textarea id="modal-sourcing-new-note" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800" rows="3" placeholder="Add a new note..."></textarea>
										<button id="modal-sourcing-note-add" class="w-full mt-2 px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-500">Add Note</button>
										<span id="modal-sourcing-note-message" class="text-sm text-green-600 mt-2 block"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				`;

            // Add event listeners for the new page
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', window.handleUserLogout);
            }
            setupTabs('inq');
            setupInquiryForm();
			            setupAdminConsole();
            listenForInquiries();        }

        // === EVENT HANDLERS & LOGIC ---
            listenForInquiries();        /**
         * Handles the main login form submission.
         * UPDATED LOGIN CREDENTIALS
         */
        function handleLogin(e) {
            e.preventDefault();
            const loginError = document.getElementById('loginError');

  // FIX: Check for auth *after* initialization attempt
            if (!window.auth) {
                console.error("Firebase Auth not available.");
                if (loginError) {
                    loginError.textContent = "Error: Services not loaded. Please refresh.";
                    loginError.classList.remove('hidden');
                }
                return;
            }

            if (!window.currentUserId) {
                console.error("Firebase not ready for login (no user ID).");
                if (loginError) {
                    loginError.textContent = "Error: Connection not ready. Please wait a moment and try again.";
                    loginError.classList.remove('hidden');
                }
                return;
            }

            // Get values and trim whitespace
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value.trim();

            let successfulLogin = false;

            // Check Inquiry logins
            if ((user === 'inq1' && pass === '123') || 
                (user === 'inq2' && pass === '456') || 
                (user === 'inq3' && pass === '789')) {
                console.log(`Login successful: Inquiry (${user})`);
                window.currentUserName = user;
                renderInquiryPage();
                successfulLogin = true;
            } 
            // Check Sourcing logins
            else if ((user === 'source1' && pass === '123') || 
                     (user === 'source2' && pass === '456') || 
                     (user === 'source3' && pass === '789')) {
                console.log(`Login successful: Sourcing (${user})`);
                window.currentUserName = user;
                localStorage.setItem('sourceUser', user); window.location.href = 'recov.html';            } 
            // Check Admin login (retained from previous version)
            else if (user === 'admin' && pass === '789') { 
                console.log("Login successful: Admin");
                window.currentUserName = 'admin';
                renderInquiryPage(); // Admins see the Inquiry dashboard by default
                successfulLogin = true;
            }

            if (successfulLogin) {
                if (loginError) loginError.classList.add('hidden');
            } else {
                console.log("Login failed: Invalid credentials");
                if (loginError) {
                    loginError.textContent = "Invalid username or password. Please try again.";
                    loginError.classList.remove('hidden');
                }
            }
        }

        /**
         * Sets up the tab switching logic for a given page.
         * @param {string} pagePrefix - 'inq' or 'source'
         */
        function setupTabs(pagePrefix) {
            let tabButtons, tabContents;

            if (pagePrefix === 'inq') {
                // Select the buttons - Admin tab included if present
                tabButtons = document.querySelectorAll('#tab-dashboard, #tab-form, #tab-analytics, #tab-admin');
                tabContents = document.querySelectorAll('#content-dashboard, #content-form, #content-analytics, #content-admin');
            } else if (pagePrefix === 'source') {
                tabButtons = document.querySelectorAll('#tab-dashboard-source, #tab-form-source');
                tabContents = document.querySelectorAll('#content-dashboard-source, #content-form-source');
            } else {
                // This fallback should not really be used, but good to have
                tabButtons = document.querySelectorAll('.tab-button');
                tabContents = document.querySelectorAll('.tab-content');
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Deactivate all buttons and hide all content
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.borderColor = 'transparent';
                        btn.style.color = '#6b7280'; // gray-500
                    });
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Activate the clicked button
                    button.classList.add('active'); // Add back the basic active class
                    const color = button.id === 'tab-admin' ? '#ef4444' : '#1e40af'; // red-500 for admin, blue-800 for others
                    button.style.borderColor = color; // Apply border color
                    button.style.color = color; // Apply text color

                    // Show the corresponding content
                    let targetContentId;
                    if (pagePrefix === 'inq') {
                        if (button.id === 'tab-dashboard') targetContentId = 'content-dashboard';
                        else if (button.id === 'tab-form') targetContentId = 'content-form';
                        else if (button.id === 'tab-analytics') targetContentId = 'content-analytics';
                        else if (button.id === 'tab-admin') {
                            targetContentId = 'content-admin';
                            // When switching to the Admin tab, re-render the Recycle Bin
                            renderRecycleBinTable(allInquiries.filter(i => i.isDeleted));
                        }
                    } else if (pagePrefix === 'source') {
                        targetContentId = button.id.replace('tab-', 'content-');
                    } else {
                        targetContentId = button.id.replace('tab-', 'content-');
                    }

                    const targetContent = document.getElementById(targetContentId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });

            // Set initial active state for the dashboard tab if it exists
            const initialDashboardTab = document.getElementById(pagePrefix === 'source' ? 'tab-dashboard-source' : 'tab-dashboard');
            if (initialDashboardTab) {
                initialDashboardTab.click(); // Simulate a click to apply styles and show content
            }
        }


        /**
         * Sets up the submission logic for the new inquiry form.
         * Uses a Firestore transaction to get a sequential ref number.
         */
        function setupInquiryForm() {
            const form = document.getElementById('new-inquiry-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Inquiry Form submitted");

                // Check for auth and required services
                if (!window.db || !window.fs || !window.fs.runTransaction || !window.fs.doc || !window.fs.getDoc) {
                    console.error("Firestore is not initialized.");
                    const formMessage = document.getElementById('form-message');
                    if (formMessage) formMessage.textContent = "Error: Database connection lost. Please try again.";
                    return;
                }

                const submitButton = document.getElementById('submit-form-btn');
                const formMessage = document.getElementById('form-message');

                // Disable button to prevent double-submit
                if (submitButton) submitButton.disabled = true;
                if (submitButton) submitButton.textContent = "Submitting...";
                if (formMessage) formMessage.textContent = "";

                // Define paths
                const INQUIRY_COLLECTION_PATH_FULL = INQUIRY_COLLECTION_PATH(window.appId);
                const COUNTER_DOC_PATH_FULL = COUNTER_DOC_PATH(window.appId);

                const counterRef = window.fs.doc(window.db, COUNTER_DOC_PATH_FULL);
                const inquiryCollectionRef = window.fs.collection(window.db, INQUIRY_COLLECTION_PATH_FULL);

                try {
                    // 1. Get all form data
                    const inquiryDataStub = {
                        clientName: document.getElementById('clientName').value.trim() || null,
                        mobileNumber: document.getElementById('mobileNumber').value.trim() || null,
                        email: document.getElementById('email').value.trim() || null,
                        organization: document.getElementById('organization').value.trim() || null,
                        material: document.getElementById('material').value.trim() || null,
                        quantity: document.getElementById('quantity').value.trim() || null,
                        specifications: document.getElementById('specifications').value.trim() || null,
                        recommendedSupplier: document.getElementById('recommendedSupplier').value.trim() || null,
                        targetPrice: document.getElementById('targetPrice').value.trim() || null,
                        timestamp: window.fs.serverTimestamp(), // Use server-side timestamp
                        status: "New", // Default status
                        notes: [], // Default empty notes array
                        isDeleted: false, // NEW: Default to not deleted
                        submittedBy: window.currentUserName // AUDIT: Log the user who submitted the form
                    };

                    // 2. Run a transaction to get the new ref number and save
                    await window.fs.runTransaction(window.db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const newRefNumber = (counterDoc.data()?.count || 0) + 1;

                        const newInquiryData = {
                            ...inquiryDataStub,
                            refNumber: newRefNumber // Add the sequential ref number
                        };

                        // Create a new doc ref with an auto-ID in the inquiries collection
                        const newInquiryRef = window.fs.doc(inquiryCollectionRef);

                        // Set the new inquiry data
                        transaction.set(newInquiryRef, newInquiryData);

                        // Update the counter
                        transaction.set(counterRef, {
                            count: newRefNumber
                        });
                    });

                    console.log("Transaction successful, document written.");

                    // 3. Show success message and reset form
                    if (formMessage) formMessage.textContent = "Inquiry submitted successfully!";
                    form.reset();

                    // 4. Automatically switch to the dashboard to see the new entry
                    setTimeout(() => {
                        const dashboardTab = document.getElementById('tab-dashboard');
                        if (dashboardTab) dashboardTab.click();
                        if (formMessage) formMessage.textContent = ""; // Clear message on tab switch
                    }, 1500);


                } catch (error) {
                    console.error("Error in transaction: ", error);
                    if (formMessage) formMessage.textContent = "Error: Could not submit form.";
                    if (error.code === 'permission-denied') {
                        if (formMessage) formMessage.textContent = "Error: You don't have permission to save data.";
                    }
                } finally {
                    // Re-enable button
                    if (submitButton) submitButton.disabled = false;
                    if (submitButton) submitButton.textContent = "Submit Inquiry";
                }
            });
        }

        /**
         * Sets up the submission logic for the SOURCING update form.
         */
        function setupSourcingForm() {
            const form = document.getElementById('new-sourcing-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Sourcing Form submitted");

                // Check for auth and required services
                if (!window.db || !window.fs || !window.fs.query || !window.fs.getDocs || !window.fs.where || !window.fs.updateDoc) {
                    console.error("Firestore is not initialized.");
                    const formMessage = document.getElementById('sourcing-form-message');
                    if (formMessage) {
                        formMessage.textContent = "Error: Database connection lost. Please try again.";
                        formMessage.className = "text-sm text-red-600";
                    }
                    return;
                }

                const submitButton = document.getElementById('submit-sourcing-form-btn');
                const formMessage = document.getElementById('sourcing-form-message');
                const refNumInput = document.getElementById('sourcingRefNum');
                const refNumber = parseInt(refNumInput.value.trim());

                if (isNaN(refNumber)) {
                    if (formMessage) {
                        formMessage.textContent = "Please enter a valid Ref #.";
                        formMessage.className = "text-sm text-red-600";
                    }
                    return;
                }

                // Disable button to prevent double-submit
                if (submitButton) submitButton.disabled = true;
                if (submitButton) submitButton.textContent = "Updating...";
                if (formMessage) formMessage.textContent = "";

                // Define path
                const INQUIRY_COLLECTION_PATH_FULL = INQUIRY_COLLECTION_PATH(window.appId);
                const inquiryCollectionRef = window.fs.collection(window.db, INQUIRY_COLLECTION_PATH_FULL);

                try {
                    // 1. Get all Sourcing form data
                    const sourcingData = {
                        sourcing_supplier: document.getElementById('sourcingSupplier').value.trim() || null,
                        sourcing_price: document.getElementById('sourcingPrice').value.trim() || null,
                        sourcing_paymentMethod: document.getElementById('sourcingPaymentMethod').value.trim() || null,
                        sourcing_coa_url: document.getElementById('sourcingCOA').value.trim() || null,
                        sourcing_license_url: document.getElementById('sourcingLicense').value.trim() || null,
                        sourcing_quality_url: document.getElementById('sourcingQualityCert').value.trim() || null,
                        // Add new status fields from form
                        sourcing_client_po: document.getElementById('sourcingClientPO').value,
                        sourcing_client_payment: document.getElementById('sourcingClientPayment').value,
                        sourcing_import_permit: document.getElementById('sourcingImportPermit').value,
                        sourcing_supplier_po: document.getElementById('sourcingSupplierPO').value,
                        // AUDIT: Who updated the sourcing fields
                        sourcingUpdatedBy: window.currentUserName 
                    };

                    // 2. Find the document with the matching refNumber
                    const q = window.fs.query(inquiryCollectionRef, window.fs.where("refNumber", "==", refNumber));
                    const querySnapshot = await window.fs.getDocs(q);

                    if (querySnapshot.empty) {
                        if (formMessage) {
                            formMessage.textContent = `Error: Inquiry with Ref #${refNumber} not found.`;
                            formMessage.className = "text-sm text-red-600";
                        }
                    } else {
                        // 3. Update the found document
                        const docToUpdate = querySnapshot.docs[0];
                        await window.fs.updateDoc(docToUpdate.ref, sourcingData);

                        console.log("Document updated successfully:", docToUpdate.id);

                        // 4. Show success message and reset form
                        if (formMessage) {
                            formMessage.textContent = `Inquiry #${refNumber} updated successfully!`;
                            formMessage.className = "text-sm text-green-600";
                        }
                        form.reset();

                        // 5. Automatically switch to the dashboard to see the new entry
                        setTimeout(() => {
                            const dashboardTab = document.getElementById('tab-dashboard-source');
                            if (dashboardTab) dashboardTab.click();
                            if (formMessage) formMessage.textContent = ""; // Clear message on tab switch
                        }, 1500);
                    }

                } catch (error) {
                    console.error("Error updating document: ", error);
                    if (formMessage) {
                        formMessage.textContent = "Error: Could not submit form.";
                        formMessage.className = "text-sm text-red-600";
                    }
                    if (error.code === 'permission-denied') {
                        if (formMessage) formMessage.textContent = "Error: You don't have permission to save data.";
                    }
                } finally {
                    // Re-enable button
                    if (submitButton) submitButton.disabled = false;
                    if (submitButton) submitButton.textContent = "Update Inquiry";
                }
            });
        }


        /**
         * Listens for real-time updates to the inquiries collection in Firestore
         * FOR THE INQUIRY DASHBOARD.
         */
        function listenForInquiries() {
            // Check for auth and required services
            if (!window.db || !window.fs || !window.fs.collection || !window.fs.query || !window.fs.onSnapshot) {
                console.error("Firestore not initialized for listener.");
                const tableBody = document.getElementById('inquiry-table-body');
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="10" class="px-6 py-10 text-center text-red-600">Error: Not connected to database. Please log out and back in.</td></tr>`;
                }
                return;
            }

            // Unsubscribe from any previous listener
            if (window.inquiryUnsubscribe) {
                window.inquiryUnsubscribe();
            }

            // Define path
            const INQUIRY_COLLECTION_PATH_FULL = INQUIRY_COLLECTION_PATH(window.appId);

            try {
                const q = window.fs.query(window.fs.collection(window.db, INQUIRY_COLLECTION_PATH_FULL));
                console.log("Attaching Firestore listener to:", INQUIRY_COLLECTION_PATH_FULL);

                window.inquiryUnsubscribe = window.fs.onSnapshot(q, (querySnapshot) => {
                    console.log("Received snapshot update (Inquiry)");
                    allInquiries = []; // Clear local cache
                    querySnapshot.forEach((doc) => {
                        allInquiries.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    // Sort by refNumber, newest first.
                    allInquiries.sort((a, b) => (b.refNumber || 0) - (a.refNumber || 0));

                    console.log("Fetched inquiries:", allInquiries);
                    filterAndRenderInquiries(); // Call filter function
                    // Also render the recycle bin if admin is logged in
                    if (window.currentUserName === 'admin' && currentView === 'inq') {
                        renderRecycleBinTable(allInquiries.filter(i => i.isDeleted));
                    }


                }, (error) => {
                    console.error("Error with Firestore listener: ", error);
                    const tableBody = document.getElementById('inquiry-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = `
								<tr>
									<td colspan="10" class="px-6 py-10 text-center text-red-600">
										Error loading data: ${error.message}
									</td>
								</tr>
							`;
                    }
                    if (error.code === 'permission-denied') {
                        console.error("Firestore Permission Denied. Check security rules.");
                    }
                });

                // Attach search bar listener
                const searchBar = document.getElementById('search-bar');
                if (searchBar) {
                    searchBar.addEventListener('input', filterAndRenderInquiries);
                }

                // Attach modal click listener
                const tableBody = document.getElementById('inquiry-table-body');
                if (tableBody) {
                    tableBody.addEventListener('click', handleInquiryTableClick);
                }

            } catch (error) {
                console.error("Failed to attach listener:", error);
            }
        }

        /**
         * Listens for real-time updates to the inquiries collection in Firestore
         * FOR THE SOURCING DASHBOARD.
         */
        function listenForInquiries_Sourcing() {
            // Check for auth and required services
            if (!window.db || !window.fs || !window.fs.collection || !window.fs.query || !window.fs.onSnapshot) {
                console.error("Firestore not initialized for listener.");
                const tableBody = document.getElementById('sourcing-table-body');
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-10 text-center text-red-600">Error: Not connected to database. Please log out and back in.</td></tr>`;
                }
                return; // FIX: Was 're turn;'
            }

            // Unsubscribe from any previous listener
            if (window.sourcingUnsubscribe) {
                window.sourcingUnsubscribe();
            }

            // Define path
            const INQUIRY_COLLECTION_PATH_FULL = INQUIRY_COLLECTION_PATH(window.appId);

            try {
                const q = window.fs.query(window.fs.collection(window.db, INQUIRY_COLLECTION_PATH_FULL));
                console.log("Attaching Firestore listener to:", INQUIRY_COLLECTION_PATH_FULL);

                window.sourcingUnsubscribe = window.fs.onSnapshot(q, (querySnapshot) => {
                    console.log("Received snapshot update (Sourcing)");
                    allInquiries = []; // Clear local cache
                    querySnapshot.forEach((doc) => {
                        allInquiries.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    // Sort by refNumber, newest first.
                    allInquiries.sort((a, b) => (b.refNumber || 0) - (a.refNumber || 0));

                    console.log("Fetched inquiries:", allInquiries);
                    filterAndRenderInquiries_Sourcing(); // Call SOURCING filter function

                }, (error) => {
                    console.error("Error with Firestore listener: ", error);
                    const tableBody = document.getElementById('sourcing-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = `
								<tr>
									<td colspan="11" class="px-6 py-10 text-center text-red-600">
										Error loading data: ${error.message}
									</td>
								</tr>
							`;
                    }
                });

                // Attach search bar listener
                const searchBar = document.getElementById('search-bar-source');
                if (searchBar) {
                    searchBar.addEventListener('input', filterAndRenderInquiries_Sourcing);
                }

                // Attach modal click listener FOR SOURCING
                const tableBody = document.getElementById('sourcing-table-body');
                if (tableBody) {
                    tableBody.addEventListener('click', handleSourcingTableClick);
                }

            } catch (error) {
                console.error("Failed to attach listener:", error);
            }
        }


        /**
         * Filters the `allInquiries` array for the INQUIRY DASHBOARD.
         */
        function filterAndRenderInquiries() {
            const searchBar = document.getElementById('search-bar');
            const searchTerm = searchBar ? searchBar.value.toLowerCase() : "";

            let filteredInquiries = allInquiries;

            if (searchTerm) {
                filteredInquiries = allInquiries.filter(inq => {
                    const formattedDate = formatTimestamp(inq.timestamp).toLowerCase();
                    return (inq.refNumber?.toString().includes(searchTerm) ||
                        (inq.clientName || "").toLowerCase().includes(searchTerm) ||
                        (inq.material || "").toLowerCase().includes(searchTerm) ||
                        (inq.organization || "").toLowerCase().includes(searchTerm) ||
                        (inq.status || "").toLowerCase().includes(searchTerm) ||
                        formattedDate.includes(searchTerm));
                });
            }

            // Filter out soft-deleted items from the main dashboard
            const finalInquiries = filteredInquiries.filter(inq => !inq.isDeleted);

            renderInquiryTable(finalInquiries);
        }

        /**
         * Filters the `allInquiries` array for the SOURCING DASHBOARD.
         */
        function filterAndRenderInquiries_Sourcing() {
            const searchBar = document.getElementById('search-bar-source');
            const searchTerm = searchBar ? searchBar.value.toLowerCase() : "";

            let filteredInquiries = allInquiries;

            if (searchTerm) {
                filteredInquiries = allInquiries.filter(inq => {
                    return (inq.refNumber?.toString().includes(searchTerm) ||
                        (inq.clientName || "").toLowerCase().includes(searchTerm) ||
                        (inq.material || "").toLowerCase().includes(searchTerm) ||
                        (inq.sourcing_supplier || "").toLowerCase().includes(searchTerm) ||
                        (inq.status || "").toLowerCase().includes(searchTerm));
                });
            }

            // Filter out soft-deleted items from the main dashboard
            const finalInquiries = filteredInquiries.filter(inq => !inq.isDeleted);

            renderSourcingTable(finalInquiries);
        }

        /**
         * Renders the fetched inquiry data into the INQUIRY dashboard table.
         */
        function renderInquiryTable(inquiries) {
            const tableBody = document.getElementById('inquiry-table-body');
            if (!tableBody) return;

            if (inquiries.length === 0) {
                tableBody.innerHTML = `
					<tr>
						<td colspan="7" class="px-6 py-10 text-center text-gray-500">
							No inquiries found.
						</td>
					</tr>
				`;
                return;
            }

            tableBody.innerHTML = inquiries.map(inq => `
				<tr class="hover:bg-gray-50" data-inquiry-id="${inq.id}">
					<td class="px-4 py-4 whitespace-nowrap text-sm">
						<a href="#" class="ref-link">${getData(inq.refNumber)}</a>
					</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${
                        inq.status === 'Completed' ? 'text-green-600' :
                        inq.status === 'In Progress' ? 'text-yellow-600' :
                        inq.status === 'Cancelled' ? 'text-red-600' : 'text-gray-700'
                    }">${getData(inq.status)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.submittedBy)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getData(inq.clientName)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.material)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.quantity)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.targetPrice)}</td>
				</tr>
			`).join('');
        }

        /**
         * Renders the fetched inquiry data into the SOURCING dashboard table.
         */
        function renderSourcingTable(inquiries) {
            const tableBody = document.getElementById('sourcing-table-body');
            if (!tableBody) return;

            if (inquiries.length === 0) {
                tableBody.innerHTML = `
					<tr>
						<td colspan="11" class="px-6 py-10 text-center text-gray-500">
							No inquiries found.
						</td>
					</tr>
				`;
                return;
            }

            tableBody.innerHTML = inquiries.map(inq => `
				<tr class="hover:bg-gray-50" data-inquiry-id="${inq.id}">
					<td class="px-4 py-4 whitespace-nowrap text-sm">
						<a href="#" class="ref-link">${getData(inq.refNumber)}</a>
					</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${
                        inq.status === 'Completed' ? 'text-green-600' :
                        inq.status === 'In Progress' ? 'text-yellow-600' :
                        inq.status === 'Cancelled' ? 'text-red-600' : 'text-gray-700'
                    }">${getData(inq.status)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getData(inq.clientName)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.material)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_supplier)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_price)}</td>
					
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_client_po)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_client_payment)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_import_permit)}</td>
					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_supplier_po)}</td>

					<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 space-x-2">
						${inq.sourcing_coa_url ? `<a href="${inq.sourcing_coa_url}" target="_blank" class="text-blue-600 hover:underline">COA</a>` : ''}
						${inq.sourcing_license_url ? `<a href="${inq.sourcing_license_url}" target="_blank" class="text-blue-600 hover:underline">Lic</a>` : ''}
						${inq.sourcing_quality_url ? `<a href="${inq.sourcing_quality_url}" target="_blank" class="text-blue-600 hover:underline">Cert</a>` : ''}
					</td>
				</tr>
			`).join('');
        }

        // === MODAL LOGIC (For Inquiry Page) ---

        /**
         * Handles clicks on the inquiry table to open the modal.
         */
        function handleInquiryTableClick(e) {
            if (e.target.classList.contains('ref-link')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                const inquiryId = row.dataset.inquiryId;
                if (!inquiryId) return;

                const inquiry = allInquiries.find(inq => inq.id === inquiryId);
                if (inquiry) {
                    showInquiryModal(inquiry);
                }
            }
        }

        /**
         * Populates and displays the inquiry modal.
         */
        function showInquiryModal(inquiry) {
            const modal = document.getElementById('inquiryModal');
            if (!modal) return;

            // === Populate Static Data ---
            document.getElementById('modal-ref-num').textContent = getData(inquiry.refNumber);
            document.getElementById('modal-submittedBy').textContent = getData(inquiry.submittedBy); // AUDIT
            document.getElementById('modal-clientName').textContent = getData(inquiry.clientName);
            document.getElementById('modal-organization').textContent = getData(inquiry.organization);
            document.getElementById('modal-mobileNumber').textContent = getData(inquiry.mobileNumber);
            document.getElementById('modal-email').textContent = getData(inquiry.email);
            document.getElementById('modal-material').textContent = getData(inquiry.material);
            document.getElementById('modal-quantity').textContent = getData(inquiry.quantity);
            document.getElementById('modal-targetPrice').textContent = getData(inquiry.targetPrice);
            document.getElementById('modal-recommendedSupplier').textContent = getData(inquiry.recommendedSupplier);
            document.getElementById('modal-specifications').textContent = getData(inquiry.specifications);

            // === Populate Status ---
            const statusSelect = document.getElementById('modal-status-select');
            statusSelect.value = inquiry.status || "New";

            // === Populate Notes ---
            renderModalNotes(inquiry.notes || [], 'modal-notes-list');

            // === Clear Messages ---
            document.getElementById('modal-status-message').textContent = "";
            document.getElementById('modal-note-message').textContent = "";
            document.getElementById('modal-new-note').value = "";

            // === Setup Delete/Restore Button (NEW) ---
            const deleteBtn = document.getElementById('modal-delete-btn');
            const deleteText = document.getElementById('modal-delete-text');
            const isDeleted = inquiry.isDeleted === true;

            // Update button appearance
            deleteBtn.classList.remove(isDeleted ? 'bg-green-500' : 'bg-red-500');
            deleteBtn.classList.remove(isDeleted ? 'hover:bg-green-600' : 'hover:bg-red-600');
            deleteBtn.classList.add(isDeleted ? 'bg-green-500' : 'bg-red-500');
            deleteBtn.classList.add(isDeleted ? 'hover:bg-green-600' : 'hover:bg-red-600');
            deleteText.textContent = isDeleted ? 'Restore Inquiry' : 'Delete Inquiry';

            // === Attach Event Listeners ---
            // Use .onclick to easily replace/remove listeners
            document.getElementById('modal-close-btn').onclick = closeInquiryModal;

            document.getElementById('modal-status-save').onclick = () => {
                handleStatusChange(inquiry.id);
            };

            document.getElementById('modal-note-add').onclick = () => {
                handleAddNote(inquiry.id);
            };

            deleteBtn.onclick = () => {
                handleSoftDelete(inquiry.id, isDeleted);
            };

            // === Show Modal ---
            modal.classList.remove('hidden');
        }

        /**
         * Renders the notes list inside the modal.
         * @param {Array} notes - The array of note objects.
         * @param {string} listElementId - The ID of the HTML element to render notes into.
         */
        function renderModalNotes(notes, listElementId) {
            const notesList = document.getElementById(listElementId);
            if (!notesList) return;
            if (notes.length === 0) {
                notesList.innerHTML = `<p class="text-gray-500 text-sm">No notes yet.</p>`;
                return;
            }

            // Sort notes, newest first. Handle both Firestore Timestamps and local Date objects.
            notes.sort((a, b) => {
                const timeA = (a.timestamp && typeof a.timestamp.toMillis === 'function') ?
                    a.timestamp.toMillis() :
                    (a.timestamp instanceof Date ? a.timestamp.getTime() : 0);
                const timeB = (b.timestamp && typeof b.timestamp.toMillis === 'function') ?
                    b.timestamp.toMillis() :
                    (b.timestamp instanceof Date ? b.timestamp.getTime() : 0);
                return timeB - timeA;
            });

            notesList.innerHTML = notes.map(note => `
				<div class="bg-white p-3 rounded shadow border border-gray-200">
					<p class="text-sm text-gray-800">${getData(note.text)}</p>
					<p class="text-xs text-gray-500 text-right mt-1">
                        Added by: <b>${getData(note.addedBy)}</b> at ${formatTimestamp(note.timestamp)}
                    </p>
				</div>
			`).join('');
        }

        /**
         * Hides the inquiry modal.
         */
        function closeInquiryModal() {
            const modal = document.getElementById('inquiryModal');
            if (modal) modal.classList.add('hidden');
            // Remove listeners by setting them to null
            document.getElementById('modal-close-btn').onclick = null;
            document.getElementById('modal-status-save').onclick = null;
            document.getElementById('modal-note-add').onclick = null;
            document.getElementById('modal-delete-btn').onclick = null; // NEW: Clear delete listener
        }

        // === MODAL LOGIC (For Sourcing Page) ---

        /**
         * Handles clicks on the SOURCING table to open the modal.
         */
        function handleSourcingTableClick(e) {
            if (e.target.classList.contains('ref-link')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                const inquiryId = row.dataset.inquiryId;
                if (!inquiryId) return;

                const inquiry = allInquiries.find(inq => inq.id === inquiryId);
                if (inquiry) {
                    showSourcingModal(inquiry);
                }
            }
        }

        /**
         * Populates and displays the SOURCING modal.
         */
        function showSourcingModal(inquiry) {
            const modal = document.getElementById('sourcingModal');
            if (!modal) return;

            // === Populate Inquiry Data ---
            document.getElementById('modal-sourcing-ref-num').textContent = getData(inquiry.refNumber);
            document.getElementById('modal-sourcing-submittedBy').textContent = getData(inquiry.submittedBy); // AUDIT
            document.getElementById('modal-sourcing-clientName').textContent = getData(inquiry.clientName);
            document.getElementById('modal-sourcing-organization').textContent = getData(inquiry.organization);
            document.getElementById('modal-sourcing-material').textContent = getData(inquiry.material);
            document.getElementById('modal-sourcing-quantity').textContent = getData(inquiry.quantity);
            document.getElementById('modal-sourcing-targetPrice').textContent = getData(inquiry.targetPrice);
            document.getElementById('modal-sourcing-specifications').textContent = getData(inquiry.specifications);

            // === Populate Sourcing Data ---
            document.getElementById('modal-sourcing-supplier').textContent = getData(inquiry.sourcing_supplier);
            document.getElementById('modal-sourcing-price').textContent = getData(inquiry.sourcing_price);
            document.getElementById('modal-sourcing-paymentMethod').textContent = getData(inquiry.sourcing_paymentMethod);

            // Handle file links
            const coaEl = document.getElementById('modal-sourcing-coa');
            const licEl = document.getElementById('modal-sourcing-license');
            const certEl = document.getElementById('modal-sourcing-quality');

            coaEl.innerHTML = inquiry.sourcing_coa_url ? `<a href="${inquiry.sourcing_coa_url}" target="_blank" class="text-blue-600 hover:underline">View File</a>` : 'N/A';
            licEl.innerHTML = inquiry.sourcing_license_url ? `<a href="${inquiry.sourcing_license_url}" target="_blank" class="text-blue-600 hover:underline">View File</a>` : 'N/A';
            certEl.innerHTML = inquiry.sourcing_quality_url ? `<a href="${inquiry.sourcing_quality_url}" target="_blank" class="text-blue-600 hover:underline">View File</a>` : 'N/A';

            // === Populate New Status Dropdowns ---
            document.getElementById('modal-sourcingClientPO').value = inquiry.sourcing_client_po || "No";
            document.getElementById('modal-sourcingClientPayment').value = inquiry.sourcing_client_payment || "Not Required";
            document.getElementById('modal-sourcingImportPermit').value = inquiry.sourcing_import_permit || "Not Required";
            document.getElementById('modal-sourcingSupplierPO').value = inquiry.sourcing_supplier_po || "Not Yet";

            // === Populate Notes ---
            renderModalNotes(inquiry.notes || [], 'modal-sourcing-notes-list');

            // === Clear Messages ---
            document.getElementById('modal-sourcing-status-message').textContent = "";
            document.getElementById('modal-sourcing-note-message').textContent = "";
            document.getElementById('modal-sourcing-new-note').value = "";

            // === Setup Delete/Restore Button (NEW) ---
            const deleteBtn = document.getElementById('modal-sourcing-delete-btn');
            const deleteText = document.getElementById('modal-sourcing-delete-text');
            const isDeleted = inquiry.isDeleted === true;

            // Update button appearance
            deleteBtn.classList.remove(isDeleted ? 'bg-green-500' : 'bg-red-500');
            deleteBtn.classList.remove(isDeleted ? 'hover:bg-green-600' : 'hover:bg-red-600');
            deleteBtn.classList.add(isDeleted ? 'bg-green-500' : 'bg-red-500');
            deleteBtn.classList.add(isDeleted ? 'hover:bg-green-600' : 'hover:bg-red-600');
            deleteText.textContent = isDeleted ? 'Restore Inquiry' : 'Delete Inquiry';


            // === Attach Event Listeners ---
            document.getElementById('modal-sourcing-close-btn').onclick = closeSourcingModal;

            document.getElementById('modal-sourcing-status-save').onclick = () => {
                handleSourcingStatusChange(inquiry.id);
            };

            document.getElementById('modal-sourcing-note-add').onclick = () => {
                handleAddNote_Sourcing(inquiry.id);
            };

            deleteBtn.onclick = () => {
                handleSoftDelete(inquiry.id, isDeleted);
            };

            // === Show Modal ---
            modal.classList.remove('hidden');
        }

        /**
         * Hides the sourcing modal.
         */
        function closeSourcingModal() {
            const modal = document.getElementById('sourcingModal');
            if (modal) modal.classList.add('hidden');
            document.getElementById('modal-sourcing-close-btn').onclick = null;
            document.getElementById('modal-sourcing-status-save').onclick = null;
            document.getElementById('modal-sourcing-note-add').onclick = null;
            document.getElementById('modal-sourcing-delete-btn').onclick = null; // NEW: Clear delete listener
        }


        /**
         * Handles saving a new status from the INQUIRY modal.
         */
        async function handleStatusChange(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc) {
                console.error("Firestore not ready");
                return;
            }

            const statusSelect = document.getElementById('modal-status-select');
            const newStatus = statusSelect.value;
            const messageEl = document.getElementById('modal-status-message');
            const saveBtn = document.getElementById('modal-status-save');
            saveBtn.disabled = true;

            // Define path
            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inquiryId);

            try {
                await window.fs.updateDoc(docRef, {
                    status: newStatus,
                    statusUpdatedBy: window.currentUserName // AUDIT: Log user who updated status
                });
                if (messageEl) messageEl.textContent = "Status updated!";
                // Update local cache
                const inq = allInquiries.find(i => i.id === inquiryId);
                if (inq) inq.status = newStatus;
                // No need to re-render table, snapshot listener will do it
            } catch (error) {
                console.error("Error updating status:", error);
                if (messageEl) messageEl.textContent = "Error updating status.";
            } finally {
                saveBtn.disabled = false;
                setTimeout(() => {
                    if (messageEl) messageEl.textContent = "";
                }, 2000);
            }
        }

        /**
         * Handles saving new statuses from the SOURCING modal.
         */
        async function handleSourcingStatusChange(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc) {
                console.error("Firestore not ready");
                return;
            }

            const messageEl = document.getElementById('modal-sourcing-status-message');
            const saveBtn = document.getElementById('modal-sourcing-status-save');
            saveBtn.disabled = true;

            // Get all 4 status values
            const newStatuses = {
                sourcing_client_po: document.getElementById('modal-sourcingClientPO').value,
                sourcing_client_payment: document.getElementById('modal-sourcingClientPayment').value,
                sourcing_import_permit: document.getElementById('modal-sourcingImportPermit').value,
                sourcing_supplier_po: document.getElementById('modal-sourcingSupplierPO').value,
                // AUDIT: Who updated the sourcing fields
                sourcingUpdatedBy: window.currentUserName 
            };

            // Define path
            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inquiryId);

            try {
                await window.fs.updateDoc(docRef, newStatuses);
                if (messageEl) messageEl.textContent = "Statuses updated!";
                // Update local cache
                const inq = allInquiries.find(i => i.id === inquiryId);
                if (inq) {
                    Object.assign(inq, newStatuses); // Merge new statuses into local object
                }
                // Snapshot listener will re-render the table
            } catch (error) {
                console.error("Error updating sourcing statuses:", error);
                if (messageEl) messageEl.textContent = "Error updating statuses.";
            } finally {
                saveBtn.disabled = false;
                setTimeout(() => {
                    if (messageEl) messageEl.textContent = "";
                }, 2000);
            }
        }

        /**
         * Handles adding a new note from the INQUIRY modal.
         */
        async function handleAddNote(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc || !window.fs.arrayUnion) {
                console.error("Firestore not ready");
                return;
            }

            const noteTextEl = document.getElementById('modal-new-note');
            const noteText = noteTextEl.value.trim();
            if (!noteText) return; // Don't add empty notes

            const messageEl = document.getElementById('modal-note-message');
            const addBtn = document.getElementById('modal-note-add');
            addBtn.disabled = true;

            // Define path
            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inquiryId);

            const newNote = {
                text: noteText,
                timestamp: new Date(), // Use local date, will be converted by Firestore
                addedBy: window.currentUserName // AUDIT: Log user who added note
            };

            try {
                await window.fs.updateDoc(docRef, {
                    notes: window.fs.arrayUnion(newNote)
                });
                if (messageEl) messageEl.textContent = "Note added!";
                noteTextEl.value = ""; // Clear textarea

                // Update local cache and re-render notes
                const inq = allInquiries.find(i => i.id === inquiryId);
                if (inq) {
                    if (!inq.notes) inq.notes = [];
                    inq.notes.push(newNote); // Add to local cache
                    renderModalNotes(inq.notes, 'modal-notes-list'); // Re-render this modal's notes
                }
            } catch (error) { // FIX: Added brace
                console.error("Error adding note:", error);
                if (messageEl) messageEl.textContent = "Error adding note.";
            } finally {
                addBtn.disabled = false;
                setTimeout(() => {
                    if (messageEl) messageEl.textContent = "";
                }, 2000);
            }
        }

        /**
         * Handles adding a new note from the SOURCING modal.
         */
        async function handleAddNote_Sourcing(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc || !window.fs.arrayUnion) {
                console.error("Firestore not ready");
                return;
            }

            const noteTextEl = document.getElementById('modal-sourcing-new-note');
            const noteText = noteTextEl.value.trim();
            if (!noteText) return; // Don't add empty notes

            const messageEl = document.getElementById('modal-sourcing-note-message');
            const addBtn = document.getElementById('modal-sourcing-note-add');
            addBtn.disabled = true;

            // Define path
            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inquiryId);

            const newNote = {
                text: noteText,
                timestamp: new Date(), // Use local date, will be converted by Firestore
                addedBy: window.currentUserName // AUDIT: Log user who added note
            };

            try {
                await window.fs.updateDoc(docRef, {
                    notes: window.fs.arrayUnion(newNote)
                });
                if (messageEl) messageEl.textContent = "Note added!";
                noteTextEl.value = ""; // Clear textarea

                // Update local cache and re-render notes
                const inq = allInquiries.find(i => i.id === inquiryId);
                if (inq) {
                    if (!inq.notes) inq.notes = [];
                    inq.notes.push(newNote); // Add to local cache
                    renderModalNotes(inq.notes, 'modal-sourcing-notes-list'); // Re-render THIS modal's notes
                }
            } catch (error) {
                console.error("Error adding note:", error);
                if (messageEl) messageEl.textContent = "Error adding note.";
            } finally {
                addBtn.disabled = false;
                setTimeout(() => {
                    if (messageEl) messageEl.textContent = "";
                }, 2000);
            }
        }

        // === NEW ADMIN/DELETION LOGIC ---

        /**
         * Performs a soft delete (or restore) on an inquiry document.
         * @param {string} inquiryId - The Firestore document ID.
         * @param {boolean} isDeleted - The current soft-deleted status.
         */
        async function handleSoftDelete(inquiryId, isDeleted) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc) {
                console.error("Firestore not ready for delete.");
                return;
            }

            const newDeleteState = !isDeleted;
            const actionText = newDeleteState ? 'Delete' : 'Restore';
            const modalId = currentView === 'inq' ? 'inquiryModal' : 'sourcingModal';
            const messageElId = currentView === 'inq' ? 'modal-status-message' : 'modal-sourcing-status-message';
            const deleteTextElId = currentView === 'inq' ? 'modal-delete-text' : 'modal-sourcing-delete-text';

            if (!confirm(`Are you sure you want to ${actionText.toLowerCase()} this inquiry (Ref #${allInquiries.find(i => i.id === inquiryId)?.refNumber || 'N/A'})?`)) {
                return;
            }

            const messageEl = document.getElementById(messageElId);
            const deleteTextEl = document.getElementById(deleteTextElId);
            const originalText = deleteTextEl.textContent;
            deleteTextEl.textContent = `${actionText}ing...`;

            try {
                const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inquiryId);
                await window.fs.updateDoc(docRef, {
                    isDeleted: newDeleteState,
                    deletedTimestamp: newDeleteState ? window.fs.serverTimestamp() : null
                });

                if (messageEl) messageEl.textContent = `Inquiry ${actionText.toLowerCase()}d successfully!`;

                // Hide modal after successful action, allowing snapshot to update
                setTimeout(() => {
                    if (currentView === 'inq') closeInquiryModal();
                    else if (currentView === 'source') closeSourcingModal();
                }, 500);

            } catch (error) {
                console.error(`Error ${actionText.toLowerCase()}ing inquiry:`, error);
                if (messageEl) messageEl.textContent = `Error ${actionText.toLowerCase()}ing inquiry.`;
            } finally {
                deleteTextEl.textContent = originalText;
                setTimeout(() => {
                    if (messageEl) messageEl.textContent = "";
                }, 3000);
            }
        }

        /**
         * Renders the soft-deleted inquiries in the Admin Console.
         * @param {Array} deletedInquiries - The array of soft-deleted inquiry objects.
         */
        function renderRecycleBinTable(deletedInquiries) {
            const tableBody = document.getElementById('recycle-bin-table-body');
            if (!tableBody) return;

            if (deletedInquiries.length === 0) {
                tableBody.innerHTML = `
					<tr>
						<td colspan="5" class="px-6 py-10 text-center text-gray-500">
							No soft-deleted inquiries.
						</td>
					</tr>
				`;
                return;
            }

            tableBody.innerHTML = deletedInquiries.map(inq => `
				<tr class="hover:bg-red-50" data-inquiry-id="${inq.id}">
					<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getData(inq.refNumber)}</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.clientName)}</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.material)}</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatTimestamp(inq.deletedTimestamp)}</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="handleSoftDelete('${inq.id}', true)" class="text-green-600 hover:text-green-900 font-medium mr-4">Restore</button>
                        <button onclick="handleHardDelete('${inq.id}')" class="text-red-600 hover:text-red-900 font-medium">Delete Permanently</button>
					</td>
				</tr>
			`).join('');
        }

        /**
         * Permanently deletes a single inquiry from the database.
         * @param {string} inquiryId - The Firestore document ID.
         */
        async function handleHardDelete(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.deleteDoc) {
                console.error("Firestore not ready for permanent delete.");
                return;
            }

            if (!confirm("DANGER: Are you absolutely sure you want to PERMANENTLY delete this inquiry? This cannot be undone.")) {
                return;
            }

            try {
                const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inquiryId);
                await window.fs.deleteDoc(docRef);
                alert(`Inquiry successfully and permanently deleted.`);

                // Snapshot listener handles table re-render
            } catch (error) {
                console.error("Error permanently deleting document:", error);
                alert(`Error deleting inquiry: ${error.message}`);
            }
        }

        /**
         * Sets up listeners for the Admin Console buttons.
         */
        function setupAdminConsole() {
            // 1. Reset Database Button
            const resetBtn = document.getElementById('reset-database-btn');
            const resetMsg = document.getElementById('reset-message');
            if (resetBtn) {
                resetBtn.addEventListener('click', async () => {
                    if (!confirm("DANGER: Are you sure you want to RESET ALL INQUIRY PROGRESS? This will soft-delete all entries and reset the Ref # counter to 0.")) return;

                    resetBtn.disabled = true;
                    resetBtn.textContent = "Resetting...";
                    resetMsg.textContent = "Processing reset operation...";
                    resetMsg.classList.remove('text-red-500');
                    resetMsg.classList.add('text-yellow-600');

                    try {
                        // 1. Soft-Delete all active inquiries
                        const activeInquiries = allInquiries.filter(i => !i.isDeleted);
                        const updatePromises = activeInquiries.map(inq => {
                            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inq.id);
                            return window.fs.updateDoc(docRef, {
                                isDeleted: true,
                                deletedTimestamp: window.fs.serverTimestamp()
                            });
                        });
                        await Promise.all(updatePromises);
                        console.log(`Soft-deleted ${activeInquiries.length} inquiries.`);

                        // 2. Reset the Counter
                        const counterRef = window.fs.doc(window.db, COUNTER_DOC_PATH(window.appId));
                        await window.fs.setDoc(counterRef, {
                            count: 0
                        });
                        console.log("Counter reset to 0.");

                        resetMsg.textContent = `Success: ${activeInquiries.length} inquiries moved to recycle bin. Counter reset to 0.`;
                        resetMsg.classList.remove('text-yellow-600');
                        resetMsg.classList.add('text-green-600');
                    } catch (error) {
                        console.error("Database reset failed:", error);
                        resetMsg.textContent = `Critical Error: Database reset failed. ${error.message}`;
                        resetMsg.classList.remove('text-yellow-600');
                        resetMsg.classList.add('text-red-600');
                    } finally {
                        resetBtn.disabled = false;
                        resetBtn.textContent = "Reset Inquiry Progress (Back to Ref #1)";
                        setTimeout(() => {
                            resetMsg.textContent = "Resets the counter to 0 and soft-deletes all existing inquiries. You must manually delete them permanently from the bin.";
                            resetMsg.classList.remove('text-green-600', 'text-red-600');
                            resetMsg.classList.add('text-red-500');
                        }, 5000);
                    }
                });
            }

            // 2. Hard Delete All Deleted Button
            const hardDeleteBtn = document.getElementById('hard-delete-deleted-btn');
            const hardDeleteMsg = document.getElementById('hard-delete-message');
            if (hardDeleteBtn) {
                hardDeleteBtn.addEventListener('click', async () => {
                    if (!confirm("ULTIMATE DANGER: Are you absolutely sure you want to PERMANENTLY DELETE ALL documents currently in the Recycle Bin? THIS CANNOT BE UNDONE.")) return;

                    hardDeleteBtn.disabled = true;
                    hardDeleteBtn.textContent = "Purging...";
                    hardDeleteMsg.textContent = "Processing permanent deletion...";
                    hardDeleteMsg.classList.remove('text-red-600');
                    hardDeleteMsg.classList.add('text-yellow-600');

                    try {
                        const deletedInquiries = allInquiries.filter(i => i.isDeleted);
                        const deletePromises = deletedInquiries.map(inq => {
                            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH(window.appId), inq.id);
                            return window.fs.deleteDoc(docRef);
                        });
                        await Promise.all(deletePromises);
                        console.log(`Permanently deleted ${deletedInquiries.length} inquiries.`);

                        hardDeleteMsg.textContent = `Success: Permanently deleted ${deletedInquiries.length} inquiries from the database.`;
                        hardDeleteMsg.classList.remove('text-yellow-600');
                        hardDeleteMsg.classList.add('text-green-600');
                    } catch (error) {
                        console.error("Permanent deletion failed:", error);
                        hardDeleteMsg.textContent = `Critical Error: Permanent deletion failed. ${error.message}`;
                        hardDeleteMsg.classList.remove('text-yellow-600');
                        hardDeleteMsg.classList.add('text-red-600');
                    } finally {
                        hardDeleteBtn.disabled = false;
                        hardDeleteBtn.textContent = "Permanently Delete All in Recycle Bin";
                        setTimeout(() => {
                            hardDeleteMsg.textContent = "This action cannot be undone. All documents with 'isDeleted: true' will be purged.";
                            hardDeleteMsg.classList.remove('text-green-600', 'text-red-600');
                            hardDeleteMsg.classList.add('text-red-500');
                        }, 5000);
                    }
                });
            }
        }

        // === INITIALIZATION ---

        /**
         * Runs when the window is fully loaded.
         */
        window.onload = () => {
            // Render the login page first
            renderLoginPage();
        };
    </script>
</body>

</html>
