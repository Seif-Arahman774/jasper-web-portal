<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jasper Industries API</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase -->
    <script type="module">
        // Ensure global app, db, auth, and other Firebase services are defined
        window.app = null;
        window.db = null;
        window.auth = null;
        window.fs = {}; // Firestore functions
        window.currentUserId = null;
        window.inquiryUnsubscribe = null; // To stop Firestore listener on logout
        window.sourcingUnsubscribe = null; // To stop Sourcing listener on logout
        window.trashUnsubscribe = null; // To stop Trash listener on logout 
        
        // ====================================================================
        // START: MANUAL CONFIGURATION FOR OTHER DEVICES
        // ====================================================================
        //
        const MANUAL_APP_ID = 'PASTE_YOUR_APP_ID_HERE'; // e.g., 'default-app-id'
        const MANUAL_FIREBASE_CONFIG = {apiKey: "AIzaSyAkFTJyLXNMfrWxV4qIt1J0FOxTa-lRU0E", authDomain: "jasper-industries-portal-6925b.firebaseapp.com", projectId: "jasper-industries-portal-6925b", storageBucket: "jasper-industries-portal-6925b.firebasestorage.app", messagingSenderId: "133802184411", appId: "1:133802184411:web:99efc56396d1c4ec0986fe", measurementId: "G-VJB2D9590N"};
        // ====================================================================
        // END: MANUAL CONFIGURATION
        // ====================================================================


        // Use manual keys if available, otherwise use the injected session keys
        window.appId = (MANUAL_APP_ID !== 'PASTE_YOUR_APP_ID_HERE' && MANUAL_APP_ID)
            ? MANUAL_APP_ID
            : (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');

        const firebaseConfigString = (MANUAL_FIREBASE_CONFIG && Object.keys(MANUAL_FIREBASE_CONFIG).length > 0)
            ? JSON.stringify(MANUAL_FIREBASE_CONFIG)
            : (typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');


        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigString);
                
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing or incomplete.");
                    // Display error to user in a non-alert way
                    const loginError = document.getElementById('loginError');
                    if (loginError) {
                        loginError.textContent = "Error: Application configuration is missing. Please contact support.";
                        loginError.classList.remove('hidden');
                    }
                    return false; // Indicate failure
                }

                console.log("Firebase Config:", firebaseConfig);

                // Import specific functions from the Firebase SDK
                const {
                    initializeApp
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const {
                    getAuth,
                    signInAnonymously, 
                    signInWithCustomToken,
                    onAuthStateChanged,
                    signOut
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const {
                    getFirestore,
                    doc,
                    setDoc,
                    addDoc,
                    onSnapshot,
                    collection,
                    query,
                    serverTimestamp,
                    setLogLevel,
                    runTransaction, // Needed for sequential counter
                    getDoc, // Needed for transaction
                    updateDoc, // Needed for status/notes
                    arrayUnion, // Needed for adding notes
                    getDocs, // Needed for Sourcing form query
                    where, // Needed for Sourcing form query
                    deleteDoc, // <-- Needed for permanent delete
                    writeBatch // <-- BUG FIX: Added for Admin Delete
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                // --- Initialize Firebase ---
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Assign firestore functions to window.fs for easy access
                window.fs = {
                    doc,
                    setDoc,
                    addDoc,
                    onSnapshot,
                    collection,
                    query,
                    serverTimestamp,
                    runTransaction,
                    getDoc,
                    updateDoc,
                    arrayUnion,
                    getDocs,
                    where,
                    deleteDoc,
                    writeBatch // <-- BUG FIX: Added for Admin Delete
                };

                // Enable debug logging for Firestore
                setLogLevel('Debug');

                // --- Authentication ---
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        console.log("Firebase Auth: User is signed in.", user.uid);
                        window.currentUserId = user.uid; 
                    } else {
                        console.log("Firebase Auth: User is signed out. Attempting to sign in...");
                        window.currentUserId = null;
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("Attempting sign in with custom token...");
                                await signInWithCustomToken(window.auth, __initial_auth_token);
                            } else {
                                console.log("Attempting anonymous sign in...");
                                await signInAnonymously(window.auth); 
                            }
                        } catch (error) {
                            console.error("Firebase Authentication Error:", error);
                            const loginError = document.getElementById('loginError');
                            if (loginError) {
                                loginError.textContent = `Authentication Failed: ${error.message}`;
                                loginError.classList.remove('hidden');
                            }
                        }
                    }
                });

                // Make signOut globally available for the logout button
                window.handleUserLogout = async () => {
                    try {
                        // Unsubscribe from Firestore listeners to prevent errors
                        if (window.inquiryUnsubscribe) {
                            console.log("Unsubscribing from inquiry listener...");
                            window.inquiryUnsubscribe();
                            window.inquiryUnsubscribe = null;
                        }
                        if (window.sourcingUnsubscribe) {
                            console.log("Unsubscribing from sourcing listener...");
                            window.sourcingUnsubscribe();
                            window.sourcingUnsubscribe = null;
                        }
                        // NEW: Unsubscribe from trash listener
                        if (window.trashUnsubscribe) {
                            console.log("Unsubscribing from trash listener...");
                            window.trashUnsubscribe();
                            window.trashUnsubscribe = null;
                        }
                        
                        console.log("Handling app-level logout.");
                        renderLoginPage();
                    } catch (error) {
                        console.error("Error during logout:", error);
                    }
                };
                return true; // Indicate success

            } catch (error) {
                console.error("Error loading Firebase SDK:", error);
                const loginError = document.getElementById('loginError');
                if (loginError) {
                    loginError.textContent = "Error loading application components. Please refresh.";
                    loginError.classList.remove('hidden');
                }
                return false; // Indicate failure
            }
        }

        // Call initialization
        initializeFirebase();

    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Basic styles for tabs */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-button.active {
            border-bottom-color: #1e40af;
            /* blue-800 */
            color: #1e40af;
            /* blue-800 */
            font-weight: 600;
        }
        
        /* Special active style for Trash tab */
        .tab-button#tab-trash.active {
            border-bottom-color: #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }


        /* Modal styles */
        #inquiryModal, #sourcingModal {
            transition: opacity 0.3s ease;
        }

        /* Styling for the ref link */
        .ref-link {
            color: #1e40af;
            /* blue-800 */
            font-weight: 500;
            text-decoration: underline;
            cursor: pointer;
        }

        .ref-link:hover {
            color: #1d4ed8;
            /* blue-700 */
        }
        
        .ref-link.trash-link {
            color: #dc2626; /* red-600 */
        }
        .ref-link.trash-link:hover {
            color: #b91c1c; /* red-700 */
        }

        /* Disabled button style for delete confirmation */
        #delete-all-data-btn:disabled {
            background-color: #fca5a5; /* red-300 */
            cursor: not-allowed;
        }

    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-blue-100">
    <!-- 
    This is the main container.
    The login page or dashboard pages will be rendered inside this div.
    -->
    <div id="app-container" class="min-h-screen">
        <!-- The login page will be rendered here by default -->
    </div>

    <!-- 
    ====================================================================
    JAVASCRIPT LOGIC
    ====================================================================
    -->
    <script>
        // --- CONSTANTS ---
        const JASPER_LOGO_URL = "https://jasperegypt.com/home/wp-content/uploads/2023/12/logooo1-1.png"; // Updated logo URL
        const INQUIRY_COLLECTION_PATH = `/artifacts/${window.appId}/public/data/inquiries`;
        const COUNTER_DOC_PATH = `/artifacts/${window.appId}/public/data/inquiries_counter/counter`;

        // --- STATE ---
        let currentView = 'login'; // 'login', 'inq', 'source', 'admin'
        let allInquiries = []; // Holds the full list of *active* inquiries
        let allTrashedInquiries = []; // Holds the list of *trashed* inquiries

        // --- UTILITY FUNCTIONS ---

        /**
         * Formats a Firestore timestamp (or Date object) into a readable string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) {
                return 'N/A';
            }
            try {
                let date;
                if (timestamp && typeof timestamp.toDate === 'function') {
                    date = timestamp.toDate();
                } else if (timestamp instanceof Date) {
                    date = timestamp;
                } else {
                    date = new Date(timestamp);
                }

                if (isNaN(date.getTime())) {
                    return 'N/A';
                }

                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (error) {
                console.error("Error formatting timestamp:", error, timestamp);
                return 'N/A';
            }
        }


        /**
         * Safely gets a value from a data object, returning 'N/A' if empty or undefined.
         */
        function getData(value) {
            return value || 'N/A';
        }

        // --- PAGE RENDERING FUNCTIONS ---

        /**
         * Clears the app container and renders the Login Page.
         */
        function renderLoginPage() {
            currentView = 'login';
            allInquiries = []; // Clear inquiry cache on logout
            allTrashedInquiries = []; // Clear trash cache on logout
            const container = document.getElementById('app-container');
            if (!container) return;

            container.innerHTML = `
                <div class="flex min-h-screen items-center justify-center bg-transparent p-4">
                    <div class="w-full max-w-md">
                        <div class="bg-white shadow-xl rounded-2xl p-8 md:p-12">
                            <div class="flex justify-center mb-8">
                                <img src="${JASPER_LOGO_URL}" alt="Jasper Industries Logo" class="h-16" onerror="this.alt='Jasper Industries'; this.src='https://placehold.co/200x60/1e40af/FFFFFF?text=Jasper';">
                            </div>
                            
                            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Internal Portal</h2>

                            <form id="loginForm">
                                <div class="mb-5">
                                    <label for="loginUser" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                    <input type="text" id="loginUser" name="loginUser"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent"
                                        required>
                                </div>
                                <div class="mb-6">
                                    <label for="loginPass" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                    <input type="password" id="loginPass" name="loginPass"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent"
                                        required>
                                </div>
                                <div class="mb-6">
                                    <button type="submit"
                                        class="w-full bg-blue-800 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-800 focus:ring-opacity-50 transition duration-200 shadow-md">
                                        Login
                                    </button>
                                </div>
                                <div id="loginError" class="hidden text-center text-red-600 text-sm font-medium p-3 bg-red-100 rounded-lg">
                                    <!-- Error messages will be inserted here --></div>
                            </form>
                        </div>
                        <p class="text-center text-gray-500 text-xs mt-6">
                            Copyright ¬© 2023 Jasper Egypt . All Rights Reserved
                        </p>
                    </div>
                </div>
            `;

            // Add event listener to the new form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        /**
         * Clears the app container and renders the Inquiry Dashboard.
         */
        function renderInquiryPage() {
            currentView = 'inq';
            const container = document.getElementById('app-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <header class="bg-white shadow-md sticky top-0 z-10">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center h-16">
                                <div class="flex items-center">
                                    <img src="${JASPER_LOGO_URL}" alt="Jasper Logo" class="h-10" onerror="this.alt='Jasper'; this.src='https://placehold.co/150x40/1e40af/FFFFFF?text=Jasper';">
                                    <span class="ml-3 text-xl font-semibold text-gray-700">Inquiry Portal</span>
                                </div>
                                <button id="logoutButton" class="text-sm font-medium text-red-600 hover:text-red-800 transition duration-150">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </header>

                    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button id="tab-dashboard" class="tab-button active text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                    Dashboard
                                </button>
                                <button id="tab-form" class="tab-button text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
                                    New Inquiry Form
                                </button>
                                <button id="tab-trash" class="tab-button text-gray-500 hover:text-red-700 hover:border-red-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
                                    üóëÔ∏è Trash
                                </button>
                                <button id="tab-analytics" class="tab-button text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
                                    Analytics
                                </button>
                            </nav>
                        </div>

                        <div>
                            <!-- Dashboard Content -->
                            <div id="content-dashboard" class="tab-content active">
                                <div class="mb-4">
                                    <input type="text" id="search-bar" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800" placeholder="Search by Ref #, Client, Material, Status, or Date...">
                                </div>
                                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Client Inquiries</h2>
                                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref #</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Organization</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target Price</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rec. Supplier</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inquiry-table-body" class="bg-white divide-y divide-gray-200">
                                                <tr>
                                                    <td colspan="10" class="px-6 py-10 text-center text-gray-500">
                                                        Loading inquiries...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- New Inquiry Form Content -->
                            <div id="content-form" class="tab-content">
                                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Submit New Client Inquiry</h2>
                                <div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
                                    <form id="new-inquiry-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="md:col-span-1">
                                            <label for="clientName" class="block text-sm font-medium text-gray-700">Client Name</label>
                                            <input type="text" id="clientName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>
                                        <div class="md:col-span-1">
                                            <label for="organization" class="block text-sm font-medium text-gray-700">Organization</label>
                                            <input type="text" id="organization" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>
                                        <div class="md:col-span-1">
                                            <label for="mobileNumber" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                                            <input type="tel" id="mobileNumber" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>
                                        <div class="md:col-span-1">
                                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                            <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>

                                        <hr class="md:col-span-2 my-2">
                                        
                                        <div class="md:col-span-1">
                                            <label for="material" class="block text-sm font-medium text-gray-700">Material</label>
                                            <input type="text" id="material" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>
                                        <div class="md:col-span-1">
                                            <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                            <input type="text" id="quantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label for="specifications" class="block text-sm font-medium text-gray-700">Specifications</label>
                                            <textarea id="specifications" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent"></textarea>
                                        </div>

                                        <hr class="md:col-span-2 my-2">

                                        <div class="md:col-span-1">
                                            <label for="recommendedSupplier" class="block text-sm font-medium text-gray-700">Recommended Supplier</label>
                                            <input type="text" id="recommendedSupplier" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>
                                        <div class="md:col-span-1">
                                            <label for="targetPrice" class="block text-sm font-medium text-gray-700">Target Price / Unit</label>
                                            <input type="text" id="targetPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-transparent">
                                        </div>

                                        <div class="md:col-span-2 flex justify-end items-center gap-4 mt-4">
                                            <span id="form-message" class="text-sm text-green-600"></span>
                                            <button type="submit" id="submit-form-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-800 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-800">
                                                Submit Inquiry
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- TRASH Content -->
                            <div id="content-trash" class="tab-content">
                                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Inquiry Trash Bin</h2>
                                <p class="text-sm text-gray-600 mb-4">Items moved to trash remain here until permanently deleted. Click the reference number to **Restore** or **Delete Permanently**.</p>
                                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-red-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref #</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody id="trash-table-body" class="bg-white divide-y divide-gray-200">
                                                <tr>
                                                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                                                        Loading trash...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Analytics Content -->
                            <div id="content-analytics" class="tab-content">
                                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Inquiry Analytics</h2>
                                <div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
                                    <p class="text-gray-600">This section will provide insights into monthly orders, average completion time, and other metrics.</p>
                                    <p class="text-gray-500 text-sm mt-4">(Analytics feature is currently under development)</p>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>

                <!-- Inquiry Modal -->
                <div id="inquiryModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-2xl font-semibold text-gray-900">Inquiry Details (Ref #: <span id="modal-ref-num"></span>)</h3>
                            <button id="modal-close-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Left Column: Details & Status -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">Client & Inquiry</h4>
                                <dl class="divide-y divide-gray-200">
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Client Name</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-clientName"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Organization</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-organization"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Contact</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><span id="modal-mobileNumber"></span><br><span id="modal-email"></span></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Material</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-material"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Quantity</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-quantity"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Target Price</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-targetPrice"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Rec. Supplier</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-recommendedSupplier"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Specs</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 whitespace-pre-wrap" id="modal-specifications"></dd></div>
                                </dl>
                                <hr class="my-4">
                                
                                <div id="modal-status-update-block">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Update Status</h4>
                                    <div class="flex items-center gap-4">
                                        <select id="modal-status-select" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
                                            <option value="New">New</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                        <button id="modal-status-save" class="px-4 py-2 bg-blue-800 text-white text-sm font-medium rounded-md hover:bg-blue-700">Save</button>
                                    </div>
                                    <span id="modal-status-message" class="text-sm text-green-600 mt-2 block"></span>
                                </div>
                                
                                <hr class="my-4 border-red-300">
                                <h4 class="text-lg font-semibold text-red-700 mb-2">Danger Zone</h4>
                                <div id="modal-action-block">
                                    <!-- This will be dynamically updated by JavaScript (Move to Trash, Restore, or Delete Permanently) -->
                                </div>
                            </div>
                            <!-- Right Column: Notes -->
                            <div class="bg-gray-50 p-4 rounded-lg flex flex-col h-full max-h-[70vh]">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">Notes</h4>
                                <div id="modal-notes-list" class="flex-grow overflow-y-auto space-y-3 mb-4 pr-2">
                                    <!-- Notes will be dynamically inserted here -->
                                    <p class="text-gray-500 text-sm">No notes yet.</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <textarea id="modal-new-note" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800" rows="3" placeholder="Add a new note..."></textarea>
                                    <button id="modal-note-add" class="w-full mt-2 px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-500">Add Note</button>
                                    <span id="modal-note-message" class="text-sm text-green-600 mt-2 block"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sourcing Modal -->
                <div id="sourcingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-2xl font-semibold text-gray-900">Sourcing Details (Ref #: <span id="modal-sourcing-ref-num"></span>)</h3>
                            <button id="modal-sourcing-close-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Left Column: Inquiry Details -->
                            <div class="md:col-span-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">Original Inquiry</h4>
                                <dl class="divide-y divide-gray-200">
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Client</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-clientName"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Org</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-organization"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Material</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-material"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Quantity</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-quantity"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Target Price</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-targetPrice"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Specs</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 whitespace-pre-wrap" id="modal-sourcing-specifications"></dd></div>
                                </dl>
                                <hr class="my-4">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">Sourcing Data</h4>
                                <dl class="divide-y divide-gray-200">
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Supplier</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-supplier"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Price</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-price"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Payment</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-paymentMethod"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">COA</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-coa"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">License</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-license"></dd></div>
                                    <div class="py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">Certificate</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="modal-sourcing-quality"></dd></div>
                                </dl>
                            </div>
                            
                            <!-- Middle Column: Sourcing Status -->
                            <div class="md:col-span-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">Update Sourcing Status</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label for="modal-sourcingClientPO" class="block text-sm font-medium text-gray-700">Client PO</label>
                                        <select id="modal-sourcingClientPO" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
                                            <option value="No">No</option>
                                            <option value="Yes">Yes</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="modal-sourcingClientPayment" class="block text-sm font-medium text-gray-700">Client Payment</label>
                                        <select id="modal-sourcingClientPayment" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
                                            <option value="Not Required">Not Required</option>
                                            <option value="Required">Required</option>
                                            <option value="Collected">Collected</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="modal-sourcingImportPermit" class="block text-sm font-medium text-gray-700">Import Permit</label>
                                        <select id="modal-sourcingImportPermit" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
                                            <option value="Not Required">Not Required</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Completed">Completed</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="modal-sourcingSupplierPO" class="block text-sm font-medium text-gray-700">Supplier PO</label>
                                        <select id="modal-sourcingSupplierPO" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800">
                                            <option value="Not Yet">Not Yet</option>
                                            <option value="Sent">Sent</option>
                                        </select>
                                    </div>
                                </div>
                                <button id="modal-sourcing-status-save" class="w-full mt-6 px-4 py-2 bg-blue-800 text-white text-sm font-medium rounded-md hover:bg-blue-700">Save Statuses</button>
                                <span id="modal-sourcing-status-message" class="text-sm text-green-600 mt-2 block"></span>
                            </div>

                            <!-- Right Column: Notes -->
                            <div class="bg-gray-50 p-4 rounded-lg flex flex-col h-full max-h-[70vh] md:col-span-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">Notes</h4>
                                <div id="modal-sourcing-notes-list" class="flex-grow overflow-y-auto space-y-3 mb-4 pr-2">
                                    <!-- Notes will be dynamically inserted here -->
                                    <p class="text-gray-500 text-sm">No notes yet.</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <textarea id="modal-sourcing-new-note" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-800" rows="3" placeholder="Add a new note..."></textarea>
                                    <button id="modal-sourcing-note-add" class="w-full mt-2 px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-500">Add Note</button>
                                    <span id="modal-sourcing-note-message" class="text-sm text-green-600 mt-2 block"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for the new page
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', window.handleUserLogout);
            }
            setupTabs('source');
            setupSourcingForm();
            listenForInquiries_Sourcing();
        }
        
        /**
         * Clears the app container and renders the Admin Console.
         */
        function renderAdminPage() {
            currentView = 'admin';
            const container = document.getElementById('app-container');
            if (!container) return;

            container.innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <header class="bg-white shadow-md sticky top-0 z-10">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center h-16">
                                <div class="flex items-center">
                                    <img src="${JASPER_LOGO_URL}" alt="Jasper Logo" class="h-10" onerror="this.alt='Jasper'; this.src='https://placehold.co/150x40/1e40af/FFFFFF?text=Jasper';">
                                    <span class="ml-3 text-xl font-semibold text-red-700">Admin Console</span>
                                </div>
                                <button id="logoutButton" class="text-sm font-medium text-red-600 hover:text-red-800 transition duration-150">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </header>

                    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">System Administration</h2>

                        <div class="bg-white shadow-lg rounded-lg p-6 md:p-8 border-t-4 border-red-600">
                            <h3 class="text-xl font-semibold text-red-700 mb-4">‚ö†Ô∏è Danger Zone: Wipe System</h3>
                            <p class="text-gray-600 mb-4">
                                This action is permanent and irreversible. It will **delete all inquiry data** and reset the **Ref # counter back to 0**. The next inquiry will be Ref #1.
                            </p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="confirm-wipe" class="block text-sm font-medium text-gray-700 mb-2">
                                        Type '<span class="font-bold text-red-600">DELETE ALL</span>' below to enable the button:
                                    </label>
                                    <input type="text" id="confirm-wipe" placeholder="DELETE ALL"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent uppercase">
                                </div>
                                
                                <button id="delete-all-data-btn" disabled 
                                    class="w-full py-3 px-4 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-600 transition duration-200">
                                    DELETE ALL DATA & RESET SYSTEM
                                </button>
                                
                                <span id="admin-message" class="text-sm text-green-600 mt-2 block"></span>
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', window.handleUserLogout);
            }
            setupAdminControls();
        }


        // --- ADMIN SPECIFIC LOGIC ---
        function setupAdminControls() {
            const input = document.getElementById('confirm-wipe');
            const button = document.getElementById('delete-all-data-btn');

            if (!input || !button) return;

            input.addEventListener('input', () => {
                button.disabled = (input.value.trim().toUpperCase() !== 'DELETE ALL');
            });

            button.addEventListener('click', handleDeleteAllData);
        }

        async function handleDeleteAllData() {
            const button = document.getElementById('delete-all-data-btn');
            const messageEl = document.getElementById('admin-message');
            
            const finalConfirmation = window.confirm("ABSOLUTELY FINAL WARNING: Are you sure you want to PERMANENTLY delete ALL data and reset the system? This cannot be undone.");
            if (!finalConfirmation) return;

            // BUG FIX: Check for writeBatch
            if (!window.db || !window.fs.getDocs || !window.fs.deleteDoc || !window.fs.setDoc || !window.fs.writeBatch) {
                messageEl.textContent = "Error: Database services not available.";
                return;
            }

            button.disabled = true;
            button.textContent = "Wiping Data...";
            messageEl.textContent = "Initiating wipe sequence... Please wait.";
            messageEl.className = "text-sm text-yellow-600 mt-2 block";


            try {
                // 1. Delete all inquiries
                const q = window.fs.query(window.fs.collection(window.db, INQUIRY_COLLECTION_PATH));
                const snapshot = await window.fs.getDocs(q);
                
                let deleteCount = 0;
                // =============================================
                // ==== BUG FIX: Use window.fs.writeBatch(window.db) ====
                // =============================================
                const batch = window.fs.writeBatch(window.db); 
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                    deleteCount++;
                });
                await batch.commit();

                // 2. Reset the counter
                const counterRef = window.fs.doc(window.db, COUNTER_DOC_PATH);
                await window.fs.setDoc(counterRef, { count: 0 }); // Reset to 0 so next is 1

                messageEl.textContent = `SUCCESS: Deleted ${deleteCount} inquiries and reset the system! Ref # will start at 1.`;
                messageEl.className = "text-sm text-green-600 mt-2 block";
                document.getElementById('confirm-wipe').value = '';

            } catch (error) {
                console.error("Admin Wipe Error:", error);
                messageEl.textContent = `CRITICAL ERROR: Failed to wipe data. ${error.message}`;
                messageEl.className = "text-sm text-red-600 mt-2 block";
            } finally {
                // Re-enable button after a delay
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = "DELETE ALL DATA & RESET SYSTEM";
                    setupAdminControls();
                }, 3000);
            }
        }


        // --- EVENT HANDLERS & LOGIC ---

        /**
         * Handles the main login form submission.
         */
        function handleLogin(e) {
            e.preventDefault();
            const loginError = document.getElementById('loginError');

            if (!window.auth) {
                console.error("Firebase Auth not available.");
                if (loginError) {
                    loginError.textContent = "Error: Services not loaded. Please refresh.";
                    loginError.classList.remove('hidden');
                }
                return;
            }
            
            // Get values and trim whitespace
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value.trim();

            // =============================================
            // ==== BUG FIX: NEW AUTHENTICATION LOGIC ====
            // =============================================
            if (user === 'admin' && pass === '123456') {
                console.log("Login successful: Admin");
                if (loginError) loginError.classList.add('hidden');
                renderAdminPage();
            } else if (user.startsWith('inq') && 
                       ((user === 'inq1' && pass === '123') || 
                        (user === 'inq2' && pass === '456') || 
                        (user === 'inq3' && pass === '789'))) {
                console.log("Login successful: Inquiry");
                if (loginError) loginError.classList.add('hidden');
                renderInquiryPage();
            } else if (user.startsWith('source') &&
                       ((user === 'source1' && pass === '123') ||
                        (user === 'source2' && pass === '456') ||
                        (user === 'source3' && pass === '789'))) {
                console.log("Login successful: Sourcing");
                if (loginError) loginError.classList.add('hidden');
                renderSourcingPage();
            } else {
                console.log("Login failed: Invalid credentials");
                if (loginError) {
                    loginError.textContent = "Invalid username or password. Please try again.";
                    loginError.classList.remove('hidden');
                }
            }
            // =============================================
        }

        /**
         * Sets up the tab switching logic for a given page.
         * Includes logic for the new Trash tab.
         */
        function setupTabs(pagePrefix) {
            let tabButtons = document.querySelectorAll('.tab-button');
            let tabContents;

            if (pagePrefix === 'inq') {
                tabContents = document.querySelectorAll('#content-dashboard, #content-form, #content-analytics, #content-trash');
            } else if (pagePrefix === 'source') {
                tabContents = document.querySelectorAll('#content-dashboard-source, #content-form-source');
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Deactivate all buttons and hide all content
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active'); 
                        btn.style.borderColor = 'transparent';
                        if (btn.id !== 'tab-trash') {
                            btn.style.color = '#6b7280'; // gray-500
                        } else {
                             btn.style.color = '#6b7280'; // gray-500
                        }
                    });
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Activate the clicked button
                    button.classList.add('active'); 
                    button.style.borderColor = '#1e40af'; // blue-800
                    button.style.color = '#1e40af'; // blue-800
                    if (button.id === 'tab-trash') {
                        button.style.borderColor = '#dc2626'; // red-600
                        button.style.color = '#dc2626'; // red-600
                    }

                    // Show the corresponding content
                    let targetContentId = button.id.replace('tab-', 'content-');
                    
                    const targetContent = document.getElementById(targetContentId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }

                    // Special logic for trash view
                    if (button.id === 'tab-trash') {
                        listenForTrashedInquiries();
                    } else if (window.trashUnsubscribe) {
                        // If we click *off* the trash tab, stop its listener
                        window.trashUnsubscribe();
                        window.trashUnsubscribe = null;
                        console.log("Unsubscribed from trash listener.");
                    }
                });
            });

            // Set initial active state for the dashboard tab if it exists
            const initialDashboardTab = document.getElementById(pagePrefix === 'source' ? 'tab-dashboard-source' : 'tab-dashboard');
            if (initialDashboardTab) {
                initialDashboardTab.click(); // Simulate a click to apply styles and show content
            }
        }


        /**
         * Sets up the submission logic for the new inquiry form.
         */
        function setupInquiryForm() {
            const form = document.getElementById('new-inquiry-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Inquiry Form submitted");

                if (!window.db || !window.fs || !window.fs.runTransaction || !window.fs.doc || !window.fs.getDoc) {
                    console.error("Firestore is not initialized.");
                    const formMessage = document.getElementById('form-message');
                    if (formMessage) formMessage.textContent = "Error: Database connection lost. Please try again.";
                    return;
                }

                const submitButton = document.getElementById('submit-form-btn');
                const formMessage = document.getElementById('form-message');

                if (submitButton) submitButton.disabled = true;
                if (submitButton) submitButton.textContent = "Submitting...";
                if (formMessage) formMessage.textContent = "";

                const counterRef = window.fs.doc(window.db, COUNTER_DOC_PATH);
                const inquiryCollectionRef = window.fs.collection(window.db, INQUIRY_COLLECTION_PATH);

                try {
                    // 1. Get all form data
                    const inquiryDataStub = {
                        clientName: document.getElementById('clientName').value.trim() || null,
                        mobileNumber: document.getElementById('mobileNumber').value.trim() || null,
                        email: document.getElementById('email').value.trim() || null,
                        organization: document.getElementById('organization').value.trim() || null,
                        material: document.getElementById('material').value.trim() || null,
                        quantity: document.getElementById('quantity').value.trim() || null,
                        specifications: document.getElementById('specifications').value.trim() || null,
                        recommendedSupplier: document.getElementById('recommendedSupplier').value.trim() || null,
                        targetPrice: document.getElementById('targetPrice').value.trim() || null,
                        timestamp: window.fs.serverTimestamp(), // Use server-side timestamp
                        status: "New", // Default status
                        notes: [] // Default empty notes array
                    };

                    // 2. Run a transaction to get the new ref number and save
                    await window.fs.runTransaction(window.db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const newRefNumber = (counterDoc.data()?.count || 0) + 1;

                        const newInquiryData = {
                            ...inquiryDataStub,
                            refNumber: newRefNumber 
                        };
                        
                        const newInquiryRef = window.fs.doc(inquiryCollectionRef);
                        transaction.set(newInquiryRef, newInquiryData);
                        transaction.set(counterRef, { count: newRefNumber });
                    });

                    console.log("Transaction successful, document written.");

                    // 3. Show success message and reset form
                    if (formMessage) formMessage.textContent = "Inquiry submitted successfully!";
                    
                    // =============================================
                    // ==== BUG FIX: Manual form reset ====
                    // =============================================
                    document.getElementById('clientName').value = '';
                    document.getElementById('mobileNumber').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('organization').value = '';
                    document.getElementById('material').value = '';
                    document.getElementById('quantity').value = '';
                    document.getElementById('specifications').value = '';
                    document.getElementById('recommendedSupplier').value = '';
                    document.getElementById('targetPrice').value = '';
                    // =============================================
                    
                    // 4. Automatically switch to the dashboard to see the new entry
                    setTimeout(() => {
                        const dashboardTab = document.getElementById('tab-dashboard');
                        if (dashboardTab) dashboardTab.click();
                        if (formMessage) formMessage.textContent = ""; // Clear message on tab switch
                    }, 1500);


                } catch (error) {
                    console.error("Error in transaction: ", error);
                    if (formMessage) formMessage.textContent = "Error: Could not submit form.";
                    if (error.code === 'permission-denied') {
                        if (formMessage) formMessage.textContent = "Error: You don't have permission to save data.";
                    }
                } finally {
                    if (submitButton) submitButton.disabled = false;
                    if (submitButton) submitButton.textContent = "Submit Inquiry";
                }
            });
        }

        /**
         * Sets up the submission logic for the SOURCING update form.
         */
        function setupSourcingForm() {
            const form = document.getElementById('new-sourcing-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Sourcing Form submitted");

                if (!window.db || !window.fs || !window.fs.query || !window.fs.getDocs || !window.fs.where || !window.fs.updateDoc) {
                    const formMessage = document.getElementById('sourcing-form-message');
                    if (formMessage) {
                        formMessage.textContent = "Error: Database connection lost. Please try again.";
                        formMessage.className = "text-sm text-red-600";
                    }
                    return;
                }

                const submitButton = document.getElementById('submit-sourcing-form-btn');
                const formMessage = document.getElementById('sourcing-form-message');
                const refNumInput = document.getElementById('sourcingRefNum');
                const refNumber = parseInt(refNumInput.value.trim());

                if (isNaN(refNumber)) {
                    if (formMessage) {
                        formMessage.textContent = "Please enter a valid Ref #.";
                        formMessage.className = "text-sm text-red-600";
                    }
                    return;
                }

                if (submitButton) submitButton.disabled = true;
                if (submitButton) submitButton.textContent = "Updating...";
                if (formMessage) formMessage.textContent = "";

                const inquiryCollectionRef = window.fs.collection(window.db, INQUIRY_COLLECTION_PATH);

                try {
                    // 1. Get all Sourcing form data
                    const sourcingData = {
                        sourcing_supplier: document.getElementById('sourcingSupplier').value.trim() || null,
                        sourcing_price: document.getElementById('sourcingPrice').value.trim() || null,
                        sourcing_paymentMethod: document.getElementById('sourcingPaymentMethod').value.trim() || null,
                        sourcing_coa_url: document.getElementById('sourcingCOA').value.trim() || null,
                        sourcing_license_url: document.getElementById('sourcingLicense').value.trim() || null,
                        sourcing_quality_url: document.getElementById('sourcingQualityCert').value.trim() || null,
                        // Add new status fields from form
                        sourcing_client_po: document.getElementById('sourcingClientPO').value,
                        sourcing_client_payment: document.getElementById('sourcingClientPayment').value,
                        sourcing_import_permit: document.getElementById('sourcingImportPermit').value,
                        sourcing_supplier_po: document.getElementById('sourcingSupplierPO').value,
                    };

                    // 2. Find the document with the matching refNumber
                    const q = window.fs.query(inquiryCollectionRef, window.fs.where("refNumber", "==", refNumber));
                    const querySnapshot = await window.fs.getDocs(q);

                    if (querySnapshot.empty) {
                        if (formMessage) {
                            formMessage.textContent = `Error: Inquiry with Ref #${refNumber} not found.`;
                            formMessage.className = "text-sm text-red-600";
                        }
                    } else {
                        // 3. Update the found document
                        const docToUpdate = querySnapshot.docs[0];
                        await window.fs.updateDoc(docToUpdate.ref, sourcingData);

                        console.log("Document updated successfully:", docToUpdate.id);

                        // 4. Show success message and reset form
                        if (formMessage) {
                            formMessage.textContent = `Inquiry #${refNumber} updated successfully!`;
                            formMessage.className = "text-sm text-green-600";
                        }
                        
                        // =============================================
                        // ==== BUG FIX: Manual form reset ====
                        // =============================================
                        document.getElementById('sourcingRefNum').value = '';
                        document.getElementById('sourcingSupplier').value = '';
                        document.getElementById('sourcingPrice').value = '';
                        document.getElementById('sourcingPaymentMethod').value = '';
                        document.getElementById('sourcingCOA').value = '';
                        document.getElementById('sourcingLicense').value = '';
                        document.getElementById('sourcingQualityCert').value = '';
                        document.getElementById('sourcingClientPO').value = 'No'; // Reset dropdowns to default
                        document.getElementById('sourcingClientPayment').value = 'Not Required';
                        document.getElementById('sourcingImportPermit').value = 'Not Required';
                        document.getElementById('sourcingSupplierPO').value = 'Not Yet';
                        // =============================================

                        // 5. Automatically switch to the dashboard to see the new entry
                        setTimeout(() => {
                            const dashboardTab = document.getElementById('tab-dashboard-source');
                            if (dashboardTab) dashboardTab.click();
                            if (formMessage) formMessage.textContent = ""; // Clear message on tab switch
                        }, 1500);
                    }

                } catch (error) {
                    console.error("Error updating document: ", error);
                    if (formMessage) {
                        formMessage.textContent = "Error: Could not submit form.";
                        formMessage.className = "text-sm text-red-600";
                    }
                    if (error.code === 'permission-denied') {
                        if (formMessage) formMessage.textContent = "Error: You don't have permission to save data.";
                    }
                } finally {
                    if (submitButton) submitButton.disabled = false;
                    if (submitButton) submitButton.textContent = "Update Inquiry";
                }
            });
        }


        /**
         * Listens for real-time updates to the inquiries collection in Firestore
         * FOR THE MAIN DASHBOARDS (Filtering out Trashed).
         */
        function listenForInquiries() {
            if (!window.db || !window.fs || !window.fs.onSnapshot) {
                const tableBody = document.getElementById('inquiry-table-body');
                if (tableBody) tableBody.innerHTML = `<tr><td colspan="10" class="px-6 py-10 text-center text-red-600">Error: Not connected to database.</td></tr>`;
                return;
            }

            // Unsubscribe from any previous listener
            if (window.inquiryUnsubscribe) {
                window.inquiryUnsubscribe();
            }

            try {
                // Query: Where status is NOT equal to "Trashed"
                const q = window.fs.query(
                    window.fs.collection(window.db, INQUIRY_COLLECTION_PATH),
                    window.fs.where("status", "!=", "Trashed")
                );

                console.log("Attaching Firestore listener to ACTIVE inquiries...");

                window.inquiryUnsubscribe = window.fs.onSnapshot(q, (querySnapshot) => {
                    console.log("Received snapshot update (Inquiry)");
                    allInquiries = []; // Clear local cache for active items
                    querySnapshot.forEach((doc) => {
                        allInquiries.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    // Sort by refNumber, newest first (client-side)
                    allInquiries.sort((a, b) => (b.refNumber || 0) - (a.refNumber || 0));

                    filterAndRenderInquiries(); 

                }, (error) => {
                    console.error("Error with Firestore listener:", error);
                });

                // Attach search bar listener
                const searchBar = document.getElementById('search-bar');
                if (searchBar) {
                    searchBar.addEventListener('input', filterAndRenderInquiries);
                }

                // Attach modal click listener
                const tableBody = document.getElementById('inquiry-table-body');
                if (tableBody) {
                    tableBody.addEventListener('click', handleInquiryTableClick);
                }

            } catch (error) {
                console.error("Failed to attach listener:", error);
            }
        }
        
        /**
         * Listens for real-time updates to the inquiries collection in Firestore
         * FOR THE TRASH TAB (Filtering FOR Trashed).
         */
        function listenForTrashedInquiries() {
            if (!window.db || !window.fs || !window.fs.onSnapshot) {
                const tableBody = document.getElementById('trash-table-body');
                if (tableBody) tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-600">Error: Not connected to database.</td></tr>`;
                return;
            }

            // Unsubscribe from any previous trash listener
            if (window.trashUnsubscribe) {
                window.trashUnsubscribe();
            }

            try {
                // Query: Where status IS equal to "Trashed"
                const q = window.fs.query(
                    window.fs.collection(window.db, INQUIRY_COLLECTION_PATH),
                    window.fs.where("status", "==", "Trashed")
                );

                console.log("Attaching Firestore listener to TRASHED inquiries...");

                window.trashUnsubscribe = window.fs.onSnapshot(q, (querySnapshot) => {
                    console.log("Received snapshot update (Trash)");
                    allTrashedInquiries = []; // Clear local cache
                    querySnapshot.forEach((doc) => {
                        allTrashedInquiries.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    // Sort by refNumber, newest first (client-side)
                    allTrashedInquiries.sort((a, b) => (b.refNumber || 0) - (a.refNumber || 0));

                    renderTrashTable(allTrashedInquiries);

                }, (error) => {
                    console.error("Error with Trash listener:", error);
                    const tableBody = document.getElementById('trash-table-body');
                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-600">Error loading trash data.</td></tr>`;
                });
                
                // Attach click listener for the Trash table
                const trashTableBody = document.getElementById('trash-table-body');
                if (trashTableBody) {
                    trashTableBody.addEventListener('click', handleTrashTableClick);
                }

            } catch (error) {
                console.error("Failed to attach trash listener:", error);
            }
        }
        

        /**
         * Listens for real-time updates to the inquiries collection in Firestore
         * FOR THE SOURCING DASHBOARD.
         */
        function listenForInquiries_Sourcing() {
            if (!window.db || !window.fs || !window.fs.onSnapshot) {
                // ... (error handling) ...
                return; 
            }

            // Unsubscribe from any previous listener
            if (window.sourcingUnsubscribe) {
                window.sourcingUnsubscribe();
            }

            try {
                // Query: Where status is NOT equal to "Trashed"
                const q = window.fs.query(
                    window.fs.collection(window.db, INQUIRY_COLLECTION_PATH),
                    window.fs.where("status", "!=", "Trashed")
                );

                console.log("Attaching Firestore listener to SOURCING active inquiries...");

                window.sourcingUnsubscribe = window.fs.onSnapshot(q, (querySnapshot) => {
                    console.log("Received snapshot update (Sourcing)");
                    allInquiries = []; // Clear local cache
                    querySnapshot.forEach((doc) => {
                        allInquiries.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    // Sort by refNumber, newest first.
                    allInquiries.sort((a, b) => (b.refNumber || 0) - (a.refNumber || 0));

                    filterAndRenderInquiries_Sourcing(); // Call SOURCING filter function

                }, (error) => {
                    console.error("Error with Sourcing listener:", error)
                });

                // Attach search bar listener
                const searchBar = document.getElementById('search-bar-source');
                if (searchBar) {
                    searchBar.addEventListener('input', filterAndRenderInquiries_Sourcing);
                }
                
                // Attach modal click listener FOR SOURCING
                const tableBody = document.getElementById('sourcing-table-body');
                if (tableBody) {
                    tableBody.addEventListener('click', handleSourcingTableClick);
                }

            } catch (error) {
                console.error("Failed to attach listener:", error);
            }
        }


        /**
         * Filters the `allInquiries` array for the MAIN INQUIRY DASHBOARD.
         */
        function filterAndRenderInquiries() {
            const searchBar = document.getElementById('search-bar');
            const searchTerm = searchBar ? searchBar.value.toLowerCase() : "";
            
            let filteredInquiries = allInquiries; // Already filtered by listener query

            if (searchTerm) {
                filteredInquiries = allInquiries.filter(inq => {
                    const formattedDate = formatTimestamp(inq.timestamp).toLowerCase();
                    return (inq.refNumber?.toString().includes(searchTerm) ||
                        (inq.clientName || "").toLowerCase().includes(searchTerm) ||
                        (inq.material || "").toLowerCase().includes(searchTerm) ||
                        (inq.organization || "").toLowerCase().includes(searchTerm) ||
                        (inq.status || "").toLowerCase().includes(searchTerm) ||
                        formattedDate.includes(searchTerm));
                });
            }

            renderInquiryTable(filteredInquiries);
        }

        /**
         * Filters the `allInquiries` array for the SOURCING DASHBOARD.
         */
        function filterAndRenderInquiries_Sourcing() {
            const searchBar = document.getElementById('search-bar-source');
            const searchTerm = searchBar ? searchBar.value.toLowerCase() : "";
            
            let filteredInquiries = allInquiries; // Already filtered by listener query

            if (searchTerm) {
                filteredInquiries = allInquiries.filter(inq => {
                    return (inq.refNumber?.toString().includes(searchTerm) ||
                        (inq.clientName || "").toLowerCase().includes(searchTerm) ||
                        (inq.material || "").toLowerCase().includes(searchTerm) ||
                        (inq.sourcing_supplier || "").toLowerCase().includes(searchTerm) ||
                        (inq.status || "").toLowerCase().includes(searchTerm));
                });
            }

            renderSourcingTable(filteredInquiries);
        }

        /**
         * Renders the fetched inquiry data into the INQUIRY dashboard table.
         */
        function renderInquiryTable(inquiries) {
            const tableBody = document.getElementById('inquiry-table-body');
            if (!tableBody) return;

            if (inquiries.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-10 text-center text-gray-500">
                            No active inquiries found.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = inquiries.map(inq => `
                <tr class="hover:bg-gray-50" data-inquiry-id="${inq.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <a href="#" class="ref-link">${getData(inq.refNumber)}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${
                        inq.status === 'Completed' ? 'text-green-600' :
                        inq.status === 'In Progress' ? 'text-yellow-600' :
                        inq.status === 'Cancelled' ? 'text-red-600' : 'text-gray-700'
                    }">${getData(inq.status)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatTimestamp(inq.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getData(inq.clientName)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.material)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.quantity)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        <div class="truncate w-36">${getData(inq.mobileNumber)}</div>
                        <div class="truncate w-36 text-xs text-gray-500">${getData(inq.email)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        <div class="truncate w-36">${getData(inq.organization)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.targetPrice)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        <div class="truncate w-36">${getData(inq.recommendedSupplier)}</div>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * Renders the fetched inquiry data into the SOURCING dashboard table.
         */
        function renderSourcingTable(inquiries) {
            const tableBody = document.getElementById('sourcing-table-body');
            if (!tableBody) return;

            if (inquiries.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-6 py-10 text-center text-gray-500">
                            No active inquiries found.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = inquiries.map(inq => `
                <tr class="hover:bg-gray-50" data-inquiry-id="${inq.id}">
                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <a href="#" class="ref-link">${getData(inq.refNumber)}</a>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${
                        inq.status === 'Completed' ? 'text-green-600' :
                        inq.status === 'In Progress' ? 'text-yellow-600' :
                        inq.status === 'Cancelled' ? 'text-red-600' : 'text-gray-700'
                    }">${getData(inq.status)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getData(inq.clientName)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.material)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_supplier)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_price)}</td>
                    
                    <!-- New Data Cells -->
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_client_po)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_client_payment)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_import_permit)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.sourcing_supplier_po)}</td>

                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 space-x-2">
                        ${inq.sourcing_coa_url ? `<a href="${inq.sourcing_coa_url}" target="_blank" class="text-blue-600 hover:underline">COA</a>` : ''}
                        ${inq.sourcing_license_url ? `<a href="${inq.sourcing_license_url}" target="_blank" class="text-blue-600 hover:underline">Lic</a>` : ''}
                        ${inq.sourcing_quality_url ? `<a href="${inq.sourcing_quality_url}" target="_blank" class="text-blue-600 hover:underline">Cert</a>` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        /**
         * Renders the trash data into the trash tab table.
         */
        function renderTrashTable(inquiries) {
            const tableBody = document.getElementById('trash-table-body');
            if (!tableBody) return;

            if (inquiries.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                            Trash is empty.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = inquiries.map(inq => `
                <tr class="hover:bg-red-50" data-inquiry-id="${inq.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <a href="#" class="ref-link trash-link">${getData(inq.refNumber)}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">TRASHED</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getData(inq.clientName)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.material)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${getData(inq.quantity)}</td>
                </tr>
            `).join('');
        }

        // --- MODAL LOGIC (For Inquiry Page) ---

        /**
         * Handles clicks on the inquiry table to open the modal.
         */
        function handleInquiryTableClick(e) {
            if (e.target.classList.contains('ref-link')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                const inquiryId = row.dataset.inquiryId;
                if (!inquiryId) return;

                const inquiry = allInquiries.find(inq => inq.id === inquiryId);
                if (inquiry) {
                    showInquiryModal(inquiry);
                }
            }
        }
        
        /**
         * Handles clicks on the trash table to open the modal.
         */
        function handleTrashTableClick(e) {
            if (e.target.classList.contains('ref-link')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                const inquiryId = row.dataset.inquiryId;
                if (!inquiryId) return;

                const inquiry = allTrashedInquiries.find(inq => inq.id === inquiryId);
                if (inquiry) {
                    showInquiryModal(inquiry);
                }
            }
        }

        /**
         * Populates and displays the inquiry modal.
         */
        function showInquiryModal(inquiry) {
            const modal = document.getElementById('inquiryModal');
            if (!modal) return;

            // --- Populate Static Data ---
            document.getElementById('modal-ref-num').textContent = getData(inquiry.refNumber);
            document.getElementById('modal-clientName').textContent = getData(inquiry.clientName);
            document.getElementById('modal-organization').textContent = getData(inquiry.organization);
            document.getElementById('modal-mobileNumber').textContent = getData(inquiry.mobileNumber);
            document.getElementById('modal-email').textContent = getData(inquiry.email);
            document.getElementById('modal-material').textContent = getData(inquiry.material);
            document.getElementById('modal-quantity').textContent = getData(inquiry.quantity);
            document.getElementById('modal-targetPrice').textContent = getData(inquiry.targetPrice);
            document.getElementById('modal-recommendedSupplier').textContent = getData(inquiry.recommendedSupplier);
            document.getElementById('modal-specifications').textContent = getData(inquiry.specifications);

            // --- Populate Status ---
            const statusSelect = document.getElementById('modal-status-select');
            statusSelect.value = inquiry.status || "New";

            // --- Populate Notes ---
            renderModalNotes(inquiry.notes || [], 'modal-notes-list');

            // --- Clear Messages & Reset Buttons ---
            document.getElementById('modal-status-message').textContent = "";
            document.getElementById('modal-note-message').textContent = "";
            document.getElementById('modal-new-note').value = "";
            document.getElementById('modal-close-btn').onclick = closeInquiryModal;

            // --- Dynamic Action Block (Trash/Restore/Delete) ---
            const actionBlock = document.getElementById('modal-action-block');
            const statusBlock = document.getElementById('modal-status-update-block');
            
            // Clear previous listeners from the action block
            actionBlock.innerHTML = ''; // Clear old buttons

            if (inquiry.status === 'Trashed') {
                // Show RESTORE and DELETE PERMANENTLY buttons
                statusBlock.style.display = 'none';
                actionBlock.innerHTML = `
                    <button id="modal-restore-btn" class="w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mb-3">
                        Restore Inquiry
                    </button>
                    <button id="modal-delete-permanently-btn" class="w-full px-4 py-2 bg-red-800 text-white text-sm font-medium rounded-md hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-offset-2">
                        Delete Permanently ‚ö†Ô∏è
                    </button>
                    <span id="modal-trash-message" class="text-sm text-red-600 mt-2 block"></span>
                `;
                document.getElementById('modal-restore-btn').onclick = () => handleRestoreInquiry(inquiry.id, inquiry.refNumber);
                document.getElementById('modal-delete-permanently-btn').onclick = () => handleDeletePermanently(inquiry.id, inquiry.refNumber);

            } else {
                // Show MOVE TO TRASH button
                statusBlock.style.display = 'block';
                actionBlock.innerHTML = `
                    <button id="modal-trash-btn" class="w-full px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Move to Trash
                    </button>
                    <p class="text-xs text-gray-500 mt-2">This will hide the inquiry from all dashboards.</p>
                    <span id="modal-trash-message" class="text-sm text-red-600 mt-2 block"></span>
                `;
                document.getElementById('modal-trash-btn').onclick = () => handleTrashInquiry(inquiry.id, inquiry.refNumber);
            }


            // --- Attach Standard Event Listeners (ensure they are refreshed) ---
            document.getElementById('modal-status-save').onclick = () => {
                handleStatusChange(inquiry.id);
            };

            document.getElementById('modal-note-add').onclick = () => {
                handleAddNote(inquiry.id);
            };
            
            // --- Show Modal ---
            modal.classList.remove('hidden');
        }

        // --- MODAL LOGIC (For Sourcing Page) ---

        /**
         * Handles clicks on the SOURCING table to open the modal.
         */
        function handleSourcingTableClick(e) {
            if (e.target.classList.contains('ref-link')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                const inquiryId = row.dataset.inquiryId;
                if (!inquiryId) return;

                const inquiry = allInquiries.find(inq => inq.id === inquiryId);
                if (inquiry) {
                    showSourcingModal(inquiry);
                }
            }
        }
        
        /**
         * Populates and displays the SOURCING modal.
         */
        function showSourcingModal(inquiry) {
            const modal = document.getElementById('sourcingModal');
            if (!modal) return;

            // --- Populate Inquiry Data ---
            document.getElementById('modal-sourcing-ref-num').textContent = getData(inquiry.refNumber);
            document.getElementById('modal-sourcing-clientName').textContent = getData(inquiry.clientName);
            document.getElementById('modal-sourcing-organization').textContent = getData(inquiry.organization);
            document.getElementById('modal-sourcing-material').textContent = getData(inquiry.material);
            document.getElementById('modal-sourcing-quantity').textContent = getData(inquiry.quantity);
            document.getElementById('modal-sourcing-targetPrice').textContent = getData(inquiry.targetPrice);
            document.getElementById('modal-sourcing-specifications').textContent = getData(inquiry.specifications);

            // --- Populate Sourcing Data ---
            document.getElementById('modal-sourcing-supplier').textContent = getData(inquiry.sourcing_supplier);
            document.getElementById('modal-sourcing-price').textContent = getData(inquiry.sourcing_price);
            document.getElementById('modal-sourcing-paymentMethod').textContent = getData(inquiry.sourcing_paymentMethod);

            // Handle file links
            const coaEl = document.getElementById('modal-sourcing-coa');
            const licEl = document.getElementById('modal-sourcing-license');
            const certEl = document.getElementById('modal-sourcing-quality');

            coaEl.innerHTML = inquiry.sourcing_coa_url ? `<a href="${inquiry.sourcing_coa_url}" target="_blank" class="text-blue-600 hover:underline">View File</a>` : 'N/A';
            licEl.innerHTML = inquiry.sourcing_license_url ? `<a href="${inquiry.sourcing_license_url}" target="_blank" class="text-blue-600 hover:underline">View File</a>` : 'N/A';
            certEl.innerHTML = inquiry.sourcing_quality_url ? `<a href="${inquiry.sourcing_quality_url}" target="_blank" class="text-blue-600 hover:underline">View File</a>` : 'N/A';
            
            // --- Populate New Status Dropdowns ---
            document.getElementById('modal-sourcingClientPO').value = inquiry.sourcing_client_po || "No";
            document.getElementById('modal-sourcingClientPayment').value = inquiry.sourcing_client_payment || "Not Required";
            document.getElementById('modal-sourcingImportPermit').value = inquiry.sourcing_import_permit || "Not Required";
            document.getElementById('modal-sourcingSupplierPO').value = inquiry.sourcing_supplier_po || "Not Yet";

            // --- Populate Notes ---
            renderModalNotes(inquiry.notes || [], 'modal-sourcing-notes-list');

            // --- Clear Messages ---
            document.getElementById('modal-sourcing-status-message').textContent = "";
            document.getElementById('modal-sourcing-note-message').textContent = "";
            document.getElementById('modal-sourcing-new-note').value = "";

            // --- Attach Event Listeners ---
            document.getElementById('modal-sourcing-close-btn').onclick = closeSourcingModal;
            
            document.getElementById('modal-sourcing-status-save').onclick = () => {
                handleSourcingStatusChange(inquiry.id);
            };

            document.getElementById('modal-sourcing-note-add').onclick = () => {
                handleAddNote_Sourcing(inquiry.id);
            };
            
            // --- Show Modal ---
            modal.classList.remove('hidden');
        }

        /**
         * Renders the notes list inside the modal.
         */
        function renderModalNotes(notes, listElementId) {
            const notesList = document.getElementById(listElementId);
            if (!notesList) return;
            if (notes.length === 0) {
                notesList.innerHTML = `<p class="text-gray-500 text-sm">No notes yet.</p>`;
                return;
            }
            
            // Sort notes, newest first
            notes.sort((a, b) => {
                const timeA = (a.timestamp && typeof a.timestamp.toMillis === 'function') 
                                ? a.timestamp.toMillis() 
                                : (a.timestamp instanceof Date ? a.timestamp.getTime() : 0);
                const timeB = (b.timestamp && typeof b.timestamp.toMillis === 'function')
                                ? b.timestamp.toMillis()
                                : (b.timestamp instanceof Date ? b.timestamp.getTime() : 0);
                return timeB - timeA;
            });

            notesList.innerHTML = notes.map(note => `
                <div class="bg-white p-3 rounded shadow border border-gray-200">
                    <p class="text-sm text-gray-800">${getData(note.text)}</p>
                    <p class="text-xs text-gray-500 text-right mt-1">${formatTimestamp(note.timestamp)}</p>
                </div>
            `).join('');
        }

        /**
         * Hides the inquiry modal.
         */
        function closeInquiryModal() {
            const modal = document.getElementById('inquiryModal');
            if (modal) modal.classList.add('hidden');
            // Remove listeners by setting them to null
            document.getElementById('modal-close-btn').onclick = null;
            document.getElementById('modal-status-save').onclick = null;
            document.getElementById('modal-note-add').onclick = null;
            // Clear dynamic buttons
            const actionBlock = document.getElementById('modal-action-block');
            if(actionBlock) actionBlock.innerHTML = '';
        }
        
        /**
         * Hides the sourcing modal.
         */
        function closeSourcingModal() {
            const modal = document.getElementById('sourcingModal');
            if (modal) modal.classList.add('hidden');
            document.getElementById('modal-sourcing-close-btn').onclick = null;
            document.getElementById('modal-sourcing-status-save').onclick = null;
            document.getElementById('modal-sourcing-note-add').onclick = null;
        }


        // --- FIREBASE UPDATE ACTIONS ---

        /**
         * Handles saving a new status from the INQUIRY modal.
         */
        async function handleStatusChange(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc) {
                console.error("Firestore not ready");
                return;
            }

            const statusSelect = document.getElementById('modal-status-select');
            const newStatus = statusSelect.value;
            const messageEl = document.getElementById('modal-status-message');
            const saveBtn = document.getElementById('modal-status-save');
            saveBtn.disabled = true;
            messageEl.textContent = "Saving...";
            messageEl.className = "text-sm text-yellow-600 mt-2 block";


            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH, inquiryId);

            try {
                await window.fs.updateDoc(docRef, {
                    status: newStatus
                });
                if(messageEl) messageEl.textContent = "Status updated!";
                messageEl.className = "text-sm text-green-600 mt-2 block";

            } catch (error) {
                console.error("Error updating status:", error);
                if(messageEl) messageEl.textContent = "Error updating status.";
                messageEl.className = "text-sm text-red-600 mt-2 block";
            } finally {
                saveBtn.disabled = false;
                setTimeout(() => { if(messageEl) messageEl.textContent = ""; }, 2000);
            }
        }
        
        /**
         * Handles saving new statuses from the SOURCING modal.
         */
        async function handleSourcingStatusChange(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc) {
                console.error("Firestore not ready");
                return;
            }

            const messageEl = document.getElementById('modal-sourcing-status-message');
            const saveBtn = document.getElementById('modal-sourcing-status-save');
            saveBtn.disabled = true;
            messageEl.textContent = "Saving...";
            messageEl.className = "text-sm text-yellow-600 mt-2 block";

            // Get all 4 status values
            const newStatuses = {
                sourcing_client_po: document.getElementById('modal-sourcingClientPO').value,
                sourcing_client_payment: document.getElementById('modal-sourcingClientPayment').value,
                sourcing_import_permit: document.getElementById('modal-sourcingImportPermit').value,
                sourcing_supplier_po: document.getElementById('modal-sourcingSupplierPO').value,
            };

            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH, inquiryId);

            try {
                await window.fs.updateDoc(docRef, newStatuses);
                if(messageEl) messageEl.textContent = "Statuses updated!";
                messageEl.className = "text-sm text-green-600 mt-2 block";

            } catch (error) {
                console.error("Error updating sourcing statuses:", error);
                if(messageEl) messageEl.textContent = "Error updating statuses.";
                messageEl.className = "text-sm text-red-600 mt-2 block";
            } finally {
                saveBtn.disabled = false;
                setTimeout(() => { if(messageEl) messageEl.textContent = ""; }, 2000);
            }
        }

        /**
         * Handles adding a new note.
         */
        async function handleAddNote(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc || !window.fs.arrayUnion) {
                console.error("Firestore not ready");
                return;
            }

            const noteTextEl = document.getElementById('modal-new-note');
            const noteText = noteTextEl.value.trim();
            if (!noteText) return; 

            const messageEl = document.getElementById('modal-note-message');
            const addBtn = document.getElementById('modal-note-add');
            addBtn.disabled = true;
            messageEl.textContent = "Adding note...";
            messageEl.className = "text-sm text-yellow-600 mt-2 block";

            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH, inquiryId);

            const newNote = {
                text: noteText,
                timestamp: window.fs.serverTimestamp() // Use server timestamp for accurate ordering
            };

            try {
                await window.fs.updateDoc(docRef, {
                    notes: window.fs.arrayUnion(newNote)
                });
                if(messageEl) messageEl.textContent = "Note added!";
                messageEl.className = "text-sm text-green-600 mt-2 block";
                noteTextEl.value = ""; 
                
            } catch (error) { 
                console.error("Error adding note:", error);
                if(messageEl) messageEl.textContent = "Error adding note.";
                messageEl.className = "text-sm text-red-600 mt-2 block";
            } finally { 
                addBtn.disabled = false;
                setTimeout(() => { if(messageEl) messageEl.textContent = ""; }, 2000);
            }
        }

        /**
         * Handles MOVING an inquiry to the trash (Soft Delete).
         */
        async function handleTrashInquiry(inquiryId, refNumber) {
            if (!window.db || !window.fs.updateDoc) {
                alert("Error: Database connection lost. Cannot move to trash.");
                return;
            }

            const messageEl = document.getElementById('modal-trash-message');
            const trashBtn = document.getElementById('modal-trash-btn');
            
            const confirmed = window.confirm(`Are you sure you want to move Inquiry Ref #${refNumber} to the trash?`);
            if (!confirmed) return;

            trashBtn.disabled = true;
            trashBtn.textContent = "Moving...";
            if (messageEl) messageEl.textContent = "";

            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH, inquiryId);

            try {
                await window.fs.updateDoc(docRef, {
                    status: "Trashed"
                });
                
                console.log("Inquiry moved to trash:", inquiryId);
                closeInquiryModal();
                // The main `listenForInquiries` listener will automatically remove it from the UI.
                // The `listenForTrashedInquiries` listener will automatically add it to the trash tab.

            } catch (error) {
                console.error("Error moving to trash:", error);
                if (messageEl) messageEl.textContent = "Error: Could not move to trash. " + error.message;
                trashBtn.disabled = false;
                trashBtn.textContent = "Move to Trash";
            }
        }
        
        /**
         * Handles RESTORING an inquiry from the trash.
         */
        async function handleRestoreInquiry(inquiryId, refNumber) {
            if (!window.db || !window.fs.updateDoc) {
                alert("Error: Database connection lost. Cannot restore.");
                return;
            }

            const restoreBtn = document.getElementById('modal-restore-btn');
            const deleteBtn = document.getElementById('modal-delete-permanently-btn');
            
            restoreBtn.disabled = true;
            deleteBtn.disabled = true;
            restoreBtn.textContent = "Restoring...";

            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH, inquiryId);

            try {
                await window.fs.updateDoc(docRef, {
                    status: "New" // Move back to active list with 'New' status
                });
                
                console.log("Inquiry restored:", inquiryId);
                closeInquiryModal();
                // Listeners will handle the UI update automatically.

            } catch (error) {
                console.error("Error restoring inquiry:", error);
                alert("Error: Could not restore inquiry.");
                restoreBtn.disabled = false;
                deleteBtn.disabled = false;
                restoreBtn.textContent = "Restore Inquiry";
            }
        }
        
        /**
         * Handles PERMANENTLY DELETING an inquiry from the trash.
         */
        async function handleDeletePermanently(inquiryId, refNumber) {
            if (!window.db || !window.fs.deleteDoc) {
                alert("Error: Database connection lost. Cannot delete permanently.");
                return;
            }

            const deleteBtn = document.getElementById('modal-delete-permanently-btn');
            const restoreBtn = document.getElementById('modal-restore-btn');
            
            const confirmed = window.confirm(`WARNING: Are you ABSOLUTELY SURE you want to PERMANENTLY delete Inquiry Ref #${refNumber}? This action cannot be undone.`);
            if (!confirmed) return;

            deleteBtn.disabled = true;
            restoreBtn.disabled = true;
            deleteBtn.textContent = "Deleting Permanently...";

            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH, inquiryId);

            try {
                await window.fs.deleteDoc(docRef);
                
                console.log("Inquiry permanently deleted:", inquiryId);
                closeInquiryModal();
                // The trash listener auto-updates the trash table.

            } catch (error) {
                console.error("Error deleting permanently:", error);
                alert("Error: Could not delete inquiry permanently.");
                deleteBtn.disabled = false;
                restoreBtn.disabled = false;
                deleteBtn.textContent = "Delete Permanently ‚ö†Ô∏è";
            }
        }


        /**
         * Handles adding a new note from the SOURCING modal.
         */
        async function handleAddNote_Sourcing(inquiryId) {
            if (!window.db || !window.fs.doc || !window.fs.updateDoc || !window.fs.arrayUnion) {
                console.error("Firestore not ready");
                return;
            }

            const noteTextEl = document.getElementById('modal-sourcing-new-note');
            const noteText = noteTextEl.value.trim();
            if (!noteText) return; // Don't add empty notes

            const messageEl = document.getElementById('modal-sourcing-note-message');
            const addBtn = document.getElementById('modal-sourcing-note-add');
            addBtn.disabled = true;
            messageEl.textContent = "Adding note...";
            messageEl.className = "text-sm text-yellow-600 mt-2 block";

            const docRef = window.fs.doc(window.db, INQUIRY_COLLECTION_PATH, inquiryId);

            const newNote = {
                text: noteText,
                timestamp: window.fs.serverTimestamp()
            };

            try {
                await window.fs.updateDoc(docRef, {
                    notes: window.fs.arrayUnion(newNote)
                });
                if(messageEl) messageEl.textContent = "Note added!";
                messageEl.className = "text-sm text-green-600 mt-2 block";
                noteTextEl.value = ""; 
                
            } catch (error) {
                console.error("Error adding note:", error);
                if(messageEl) messageEl.textContent = "Error adding note.";
                messageEl.className = "text-sm text-red-600 mt-2 block";
            } finally {
                addBtn.disabled = false;
                setTimeout(() => { if(messageEl) messageEl.textContent = ""; }, 2000);
            }
        }


        // --- INITIALIZATION ---

        /**
         * Runs when the window is fully loaded.
         */
        window.onload = () => {
            // Render the login page first
            renderLoginPage();
        };
    </script>
</body>

</html>
